# SUBPLAN FILTER

The `SUBPLAN FILTER` operator drives the execution of subqueries in expressions.

OceanBase Database executes the `SUBPLAN FILTER` operator by using a nested loop algorithm, where a row of data on the left is taken to execute a subplan on the right. The `SUBPLAN FILTER` operator can drive the execution of correlated and non-correlated subqueries, but in different ways.

## Drive the execution of a non-correlated subquery

Example 1: The `SUBPLAN FILTER` operator drives the execution of a non-correlated subquery.

```sql
obclient> CREATE TABLE t1(c1 INT, c2 INT);
Query OK, 0 rows affected

obclient> CREATE TABLE t2(c1 INT, c2 INT);
Query OK, 0 rows affected

obclient> EXPLAIN SELECT /*+NO_REWRITE*/c1 FROM t1 WHERE c2 > (SELECT MAX(c2) FROM t2);

+---------------------------------------------------------------------------------------------------+
| Query Plan                                                                                        |
+---------------------------------------------------------------------------------------------------+
| ===================================================                                               |
| |ID|OPERATOR           |NAME|EST.ROWS|EST.TIME(us)|                                               |
| ---------------------------------------------------                                               |
| |0 |SUBPLAN FILTER     |    |1       |5           |                                               |
| |1 |├─TABLE FULL SCAN  |t1  |1       |3           |                                               |
| |2 |└─SCALAR GROUP BY  |    |1       |3           |                                               |
| |3 |  └─TABLE FULL SCAN|t2  |1       |3           |                                               |
| ===================================================                                               |
| Outputs & filters:                                                                                |
| -------------------------------------                                                             |
|   0 - output([t1.c1]), filter(nil), rowset=16                                                     |
|       exec_params_(nil), onetime_exprs_([subquery(1)(:0)]), init_plan_idxs_(nil), use_batch=false |
|   1 - output([t1.c1]), filter([t1.c2 > :0]), rowset=16                                            |
|       access([t1.c2], [t1.c1]), partitions(p0)                                                    |
|       is_index_back=false, is_global_index=false, filter_before_indexback[false],                 |
|       range_key([t1.__pk_increment]), range(MIN ; MAX)always true                                 |
|   2 - output([T_FUN_MAX(T_FUN_MAX(t2.c2))]), filter(nil), rowset=16                               |
|       group(nil), agg_func([T_FUN_MAX(T_FUN_MAX(t2.c2))])                                         |
|   3 - output([T_FUN_MAX(t2.c2)]), filter(nil), rowset=16                                          |
|       access([t2.c2]), partitions(p0)                                                             |
|       is_index_back=false, is_global_index=false,                                                 |
|       range_key([t2.__pk_increment]), range(MIN ; MAX)always true,                                |
|       pushdown_aggregation([T_FUN_MAX(t2.c2)])                                                    |
+---------------------------------------------------------------------------------------------------+
23 rows in set
```

In the preceding example, Operator 0 `SUBPLAN FILTER` in the execution plan drives the execution of `SCALAR GROUP BY` subplans on the right. The `Outputs & filters` section shows in detail the output information of the `SUBPLAN FILTER` operator.

| **Field** | **Description** |
|----------------|------------------------|
| output | The output columns of the operator.  |
| filter | The filter conditions of the operator. In this example, `filter` is set to `nil` because no filter condition is configured for the `SUBPLAN FILTER` operator.  |
| exec_params_ | A parameter of the left subplan on which the execution of the right subplan depends. During execution, the `SUBPLAN FILTER` operator obtains the parameter from the left subplan and passes it to the right subplan for execution. In this example, the parameter is set to `nil` because the `SUBPLAN FILTER` operator drives a non-correlated subquery.  |
| onetime_exprs_ | An expression that is calculated only once in the execution plan. If the right subplan is for a non-correlated subquery, its result would be the same each time it is executed. So, the result is saved to the parameter set after the first execution. Upon each execution of the `SUBPLAN FILTER` operator, this result may be directly taken from the parameter set to serve as the execution result of the right subplan. The `subquery(1)` parameter indicates that `onetime_exprs_` applies to the first subplan on the right of `SUBPLAN FILTER`.  |

Generally, the `SUBPLAN FILTER` operator drives the execution of a non-correlated subquery by following this process:

1. The `SUBPLAN FILTER` operator starts by executing `onetime_exprs_`.

2. It obtains the result of the non-correlated subquery on the right from the parameter set and pushes `filter` down to the left subplan to execute the left subquery.

3. It then outputs the rows of the left subquery.

## Drive the execution of a correlated subquery

Example 2: The `SUBPLAN FILTER` operator drives the execution of a correlated subquery.

```sql
obclient> EXPLAIN SELECT /*+NO_REWRITE*/c1 FROM t1 WHERE c2 > (SELECT MAX(c2) FROM t2 WHERE t1.c1=t2.c1);

+---------------------------------------------------------------------------------------------+
| Query Plan                                                                                  |
+---------------------------------------------------------------------------------------------+
| ===================================================                                         |
| |ID|OPERATOR           |NAME|EST.ROWS|EST.TIME(us)|                                         |
| ---------------------------------------------------                                         |
| |0 |SUBPLAN FILTER     |    |1       |5           |                                         |
| |1 |├─TABLE FULL SCAN  |t1  |1       |3           |                                         |
| |2 |└─SCALAR GROUP BY  |    |1       |3           |                                         |
| |3 |  └─TABLE FULL SCAN|t2  |1       |3           |                                         |
| ===================================================                                         |
| Outputs & filters:                                                                          |
| -------------------------------------                                                       |
|   0 - output([t1.c1]), filter([t1.c2 > subquery(1)]), rowset=16                             |
|       exec_params_([t1.c1(:0)]), onetime_exprs_(nil), init_plan_idxs_(nil), use_batch=false |
|   1 - output([t1.c1], [t1.c2]), filter(nil), rowset=16                                      |
|       access([t1.c1], [t1.c2]), partitions(p0)                                              |
|       is_index_back=false, is_global_index=false,                                           |
|       range_key([t1.__pk_increment]), range(MIN ; MAX)always true                           |
|   2 - output([T_FUN_MAX(T_FUN_MAX(t2.c2))]), filter(nil), rowset=16                         |
|       group(nil), agg_func([T_FUN_MAX(T_FUN_MAX(t2.c2))])                                   |
|   3 - output([T_FUN_MAX(t2.c2)]), filter([:0 = t2.c1]), rowset=16                           |
|       access([t2.c1], [t2.c2]), partitions(p0)                                              |
|       is_index_back=false, is_global_index=false, filter_before_indexback[false],           |
|       range_key([t2.__pk_increment]), range(MIN ; MAX)always true,                          |
|       pushdown_aggregation([T_FUN_MAX(t2.c2)])                                              |
+---------------------------------------------------------------------------------------------+
23 rows in set
```

In the preceding example, Operator 0 `SUBPLAN FILTER` in the execution plan drives the execution of `SCALAR GROUP BY` subplans on the right. The `Outputs & filters` section shows in detail the output information of the `SUBPLAN FILTER` operator.

| **Field** | **Description** |
|-----------------|------------------------|
| output | The output columns of the operator.  |
| filter | The filter conditions of the operator. For instance, the filter condition for the SQL query in Example 2 is `t1.c2 > subquery(1)`.  |
| exec_params_ | A parameter of the left subplan on which the execution of the right subplan depends. During execution, the `SUBPLAN FILTER` operator obtains the parameter from the left subplan and passes it to the right subplan for execution. These are parameters to be pushed down to the right after a row of output data is exported from the left, and are generally not present for a non-correlated subquery.  |
| onetime_exprs_ | An expression that is calculated only once in the execution plan. If the right subplan is for a non-correlated subquery, its result would be the same each time it is executed. So, the result is saved to the parameter set after the first execution. Upon each execution of the `SUBPLAN FILTER` operator, this result may be directly taken from the parameter set to serve as the execution result of the right subplan. The `subquery(1)` parameter indicates that `onetime_exprs_` applies to the first subplan on the right of `SUBPLAN FILTER`. In this example, this parameter is set to `nil` because it is not configured for the SQL query.  |

Generally, the `SUBPLAN FILTER` operator drives the execution of a correlated subquery by following this process:

1. The `SUBPLAN FILTER` operator starts by executing `onetime_exprs_`.

2. It executes the left subquery and, after exporting a row, calculates relevant parameters and pushes them down to the right to execute the right subquery.

3. It then executes `filter` to export rows of data that meet the condition.