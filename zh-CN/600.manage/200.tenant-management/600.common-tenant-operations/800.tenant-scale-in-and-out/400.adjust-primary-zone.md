|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# 通过调整 Primary Zone 实现租户扩缩容

本文介绍如何通过修改 Primary Zone，达到租户扩容的功能。

## 前提条件

在进行租户的扩容和缩容操作前，需要进行以下操作：

* 设置租户内的负载均衡策略。

  租户内的负载均衡策略由租户级配置项 `enable_rebalance` 和 `enable_transfer` 共同控制。

  配置项 `enable_rebalance` 在系统租户下用于控制是否进行租户间的负载均衡；在用户租户下用于控制是否进行租户内均衡。默认值为 `true`，设置后不需要重启 OBServer 节点，立即生效。

  配置项 `enable_transfer` 用于控制是否开启租户下的 Transfer 功能，默认值为 `true`，设置后不需要重启 OBServer 节点，立即生效。配置项 `enable_transfer` 值的含义依赖配置项 `enable_rebalance` 的取值：
  
  * 当配置项 `enable_rebalance` 的值为 `false` 时，无论配置项 `enable_transfer` 的值为 `true` 还是 `false`，系统均不会进行自动负载均衡。

  * 当配置项 `enable_rebalance` 的值为 `true` 且 `enable_transfer` 的值为 `true` 时，表示在进行租户扩缩容操作时，系统会自动调整分区分布，实现负载均衡。

  * 当配置项 `enable_rebalance` 的值为 `true` 且 `enable_transfer` 的值为 `false` 时，表示在进行租户扩缩容操作时，系统不能发起 Transfer 操作，只能通过日志流迁移实现有限的均衡。

  具体设置方法如下：

  * 系统租户设置指定租户的负载均衡策略

    * 系统租户开启指定租户的租户内负载均衡和租户下的 Transfer 功能

      ```sql
      ALTER SYSTEM SET enable_rebalance = true TENANT = 'tenant_name';
      ```

      ```sql
      ALTER SYSTEM SET enable_transfer = true TENANT = 'tenant_name';
      ```

      以上语句表示仅指定租户下的配置项 `enable_rebalance` 和 `enable_transfer` 的值为 `true`。

    * 系统租户开启所有用户租户（不含 `sys` 租户和 Meta 租户）的租户内负载均衡和租户下的 Transfer 功能

      ```sql
      ALTER SYSTEM SET enable_rebalance = true TENANT = all_user;
      ```

      ```sql
      ALTER SYSTEM SET enable_transfer = true TENANT = all_user;
      ```

      或者

      ```sql
      ALTER SYSTEM SET enable_rebalance = true TENANT = all;
      ```

      ```sql
      ALTER SYSTEM SET enable_transfer = true TENANT = all;
      ```

      以上语句表示所有用户租户下配置项 `enable_rebalance` 和 `enable_transfer` 的值为 `true`。

      <main id="notice" type='explain'>
      <h4>说明</h4>
      <p>OceanBase 数据库从 V4.2.1 版本开始，<code>TENANT = all_user</code> 与 <code>TENANT = all</code>语义相同，在需要生效范围为所有用户租户时，推荐使用 <code>TENANT = all_user</code>，后续 <code>TENANT = all</code> 将废弃不再使用。</p>
      </main>

  * 用户租户设置本租户的负载均衡策略

      :::tab
      tab MySQL 模式

      MySQL 租户开启本租户的租户内负载均衡和租户下的 Transfer 功能的语句如下：

      ```sql
      ALTER SYSTEM SET enable_rebalance = true;
      ```

      ```sql
      ALTER SYSTEM SET enable_transfer = true;
      ```

      tab Oracle 模式

      Oracle 租户开启本租户的租户内负载均衡和租户下的 Transfer 功能的语句如下：

      ```sql
      ALTER SYSTEM SET enable_rebalance = 'true';
      ```

      ```sql
      ALTER SYSTEM SET enable_transfer = 'true';
      ```

      :::

  更多配置项 `enable_rebalance` 和 `enable_transfer` 的详细说明，请参见 [enable_rebalance](../../../../700.reference/800.configuration-items-and-system-variables/100.system-configuration-items/400.tenant-level-configuration-items/6700.enable_rebalance.md) 和 [enable_transfer](../../../../700.reference/800.configuration-items-and-system-variables/100.system-configuration-items/400.tenant-level-configuration-items/25600.enable_transfer.md)。

* 执行租户扩容操作前，需要先进行租户的资源规划，防止扩容后因资源不足而影响业务。

  有关租户扩缩容资源规划的详细操作，参见[租户扩缩容的资源规划](150.resources-planning-for-tenant-scale-in-and-out.md)。

## 增加 Primary Zone

1. 使用 `root` 用户登录到集群的 `sys` 租户。

    ```shell
    obclient -h172.30.xxx.xxx -P2883 -uroot@sys#obdemo -pxxxx -A
    ```

2. 进入 `oceanbase` 数据库。

    ```sql
    use oceanbase;
    ```

3. 查询租户 `mysql001` 的基本信息，例如 `locality`、`primary zone` 等属性。

   ```sql
   SELECT * FROM oceanbase.DBA_OB_TENANTS WHERE tenant_id = 1006;
   ```

   查询结果如下：

   ```shell
   +-----------+-------------+-------------+----------------------------+----------------------------+-------------------+---------------------------------------------+-------------------+--------------------+--------+---------------+--------+-------------+-------------------+------------------+---------------------+---------------------+---------------------+---------------------+--------------+----------------------------+----------+------------+-----------+
   | TENANT_ID | TENANT_NAME | TENANT_TYPE | CREATE_TIME                | MODIFY_TIME                | PRIMARY_ZONE      | LOCALITY                                    | PREVIOUS_LOCALITY | COMPATIBILITY_MODE | STATUS | IN_RECYCLEBIN | LOCKED | TENANT_ROLE | SWITCHOVER_STATUS | SWITCHOVER_EPOCH | SYNC_SCN            | REPLAYABLE_SCN      | READABLE_SCN        | RECOVERY_UNTIL_SCN  | LOG_MODE     | ARBITRATION_SERVICE_STATUS | UNIT_NUM | COMPATIBLE | MAX_LS_ID |
   +-----------+-------------+-------------+----------------------------+----------------------------+-------------------+---------------------------------------------+-------------------+--------------------+--------+---------------+--------+-------------+-------------------+------------------+---------------------+---------------------+---------------------+---------------------+--------------+----------------------------+----------+------------+-----------+
   |      1006 | mysql001    | USER        | 2023-09-25 17:06:51.025654 | 2023-09-25 17:07:31.606415 | zone1;zone2;zone3 | FULL{1}@zone1, FULL{1}@zone2, FULL{1}@zone3 | NULL              | MYSQL              | NORMAL | NO            | NO     | PRIMARY     | NORMAL            |                0 | 1695633705492686782 | 1695633705492686782 | 1695633705492686782 | 4611686018427387903 | NOARCHIVELOG | DISABLED                   |        2 | 4.2.1.0    |      1002 |
   +-----------+-------------+-------------+----------------------------+----------------------------+-------------------+---------------------------------------------+-------------------+--------------------+--------+---------------+--------+-------------+-------------------+------------------+---------------------+---------------------+---------------------+---------------------+--------------+----------------------------+----------+------------+-----------+
   1 row in set
   ```

4. 查询租户 `mysql001` 的 Unit 信息，在单个 Zone 的 `unit num` 为 2。

   ```sql
   SELECT * FROM oceanbase.DBA_OB_UNITS WHERE tenant_id = 1006;
   ```

   查询结果如下：

   ```shell
   +---------+-----------+--------+------------------+---------------+----------------------------+----------------------------+-------+----------------+----------+---------------------+-----------------------+----------------+----------------+---------+---------+-------------+---------------+---------------------+---------------------+-------------+
   | UNIT_ID | TENANT_ID | STATUS | RESOURCE_POOL_ID | UNIT_GROUP_ID | CREATE_TIME                | MODIFY_TIME                | ZONE  | SVR_IP         | SVR_PORT | MIGRATE_FROM_SVR_IP | MIGRATE_FROM_SVR_PORT | MANUAL_MIGRATE | UNIT_CONFIG_ID | MAX_CPU | MIN_CPU | MEMORY_SIZE | LOG_DISK_SIZE | MAX_IOPS            | MIN_IOPS            | IOPS_WEIGHT |
   +---------+-----------+--------+------------------+---------------+----------------------------+----------------------------+-------+----------------+----------+---------------------+-----------------------+----------------+----------------+---------+---------+-------------+---------------+---------------------+---------------------+-------------+
   |    1016 |      1006 | ACTIVE |             1003 |          1006 | 2023-09-25 17:06:38.569419 | 2023-09-25 17:06:51.030929 | zone1 | xxx.xx.xxx.194 |     2882 | NULL                |                  NULL | NULL           |           1002 |       1 |       1 |  5368709120 |   16106127360 | 9223372036854775807 | 9223372036854775807 |           1 |
   |    1017 |      1006 | ACTIVE |             1003 |          1007 | 2023-09-25 17:06:38.571540 | 2023-09-25 17:06:51.030929 | zone1 | xxx.xx.xxx.198 |     2882 | NULL                |                  NULL | NULL           |           1002 |       1 |       1 |  5368709120 |   16106127360 | 9223372036854775807 | 9223372036854775807 |           1 |
   |    1018 |      1006 | ACTIVE |             1003 |          1006 | 2023-09-25 17:06:38.573614 | 2023-09-25 17:06:51.030929 | zone2 | xxx.xx.xxx.192 |     2882 | NULL                |                  NULL | NULL           |           1002 |       1 |       1 |  5368709120 |   16106127360 | 9223372036854775807 | 9223372036854775807 |           1 |
   |    1019 |      1006 | ACTIVE |             1003 |          1007 | 2023-09-25 17:06:38.575723 | 2023-09-25 17:06:51.030929 | zone2 | xxx.xx.xxx.196 |     2882 | NULL                |                  NULL | NULL           |           1002 |       1 |       1 |  5368709120 |   16106127360 | 9223372036854775807 | 9223372036854775807 |           1 |
   |    1020 |      1006 | ACTIVE |             1003 |          1006 | 2023-09-25 17:06:38.579946 | 2023-09-25 17:06:51.031986 | zone3 | xxx.xx.xxx.204 |     2882 | NULL                |                  NULL | NULL           |           1002 |       1 |       1 |  5368709120 |   16106127360 | 9223372036854775807 | 9223372036854775807 |           1 |
   |    1021 |      1006 | ACTIVE |             1003 |          1007 | 2023-09-25 17:06:38.581002 | 2023-09-25 17:06:51.031986 | zone3 | xxx.xx.xxx.197 |     2882 | NULL                |                  NULL | NULL           |           1002 |       1 |       1 |  5368709120 |   16106127360 | 9223372036854775807 | 9223372036854775807 |           1 |
   +---------+-----------+--------+------------------+---------------+----------------------------+----------------------------+-------+----------------+----------+---------------------+-----------------------+----------------+----------------+---------+---------+-------------+---------------+---------------------+---------------------+-------------+
   6 rows in set
   ```

5. 修改租户 `mysql001` 的 `PRIMARY_ZONE` 属性，从 1 调整为 2。

   ```sql
   ALTER TENANT mysql001 PRIMARY_ZONE='zone1,zone2;zone3'; 
   ```

6. 查看增加 Primary Zone 任务的执行状态。

   ```sql
   SELECT * FROM oceanbase.DBA_OB_TENANT_JOBS WHERE JOB_TYPE='ALTER_TENANT_PRIMARY_ZONE' AND tenant_id = 1006;
   ```

   查询结果如下：

   ```shell
   +--------+---------------------------+------------+-------------+----------+----------------------------+----------------------------+-----------+--------------------------------------------------------+-------------------+----------------+-------------+
   | JOB_ID | JOB_TYPE                  | JOB_STATUS | RESULT_CODE | PROGRESS | START_TIME                 | MODIFY_TIME                | TENANT_ID | SQL_TEXT                                               | EXTRA_INFO        | RS_SVR_IP      | RS_SVR_PORT |
   +--------+---------------------------+------------+-------------+----------+----------------------------+----------------------------+-----------+--------------------------------------------------------+-------------------+----------------+-------------+
   |      4 | ALTER_TENANT_PRIMARY_ZONE | SUCCESS    |           0 |      100 | 2023-09-25 17:26:00.069089 | 2023-09-25 17:26:20.919021 |      1006 | ALTER TENANT mysql001 PRIMARY_ZONE='zone1,zone2;zone3' | zone1;zone2;zone3 | xxx.xx.xxx.196 |        2882 |
   +--------+---------------------------+------------+-------------+----------+----------------------------+----------------------------+-----------+--------------------------------------------------------+-------------------+----------------+-------------+
   1 row in set
   ```

   查询结果中，根据以下字段，找到对应的任务记录：

   * `START_TIME`：任务的发起时间。
   * `SQL_TEXT`：任务对应的 SQL 语句。
   * `EXTRA_INFO`：变更前后的 Primary Zone 信息。

   当对应任务记录中 `JOB_STATUS` 的值为 `SUCCESS` 时，表示增加 Primary Zone 的任务执行成功。

   有关视图 `DBA_OB_TENANT_JOBS` 的详细字段说明，请参见 [DBA_OB_TENANT_JOBS](../../../../700.reference/700.system-views/300.system-view-of-sys-tenant/200.dictionary-view-of-sys-tenant/5700.oceanbase-dba_ob_tenant_jobs-of-sys-tenant.md)。

7. 查询租户 `mysql001` 的基本信息，确认 `PRIMARY_ZONE` 属性修改成功，第一优先级由 `zone1` 变更为 `zone1,zone2`。

   ```sql
   SELECT * FROM oceanbase.DBA_OB_TENANTS WHERE tenant_id = 1006;
   ```

   查询结果如下：

   ```shell
   +-----------+-------------+-------------+----------------------------+----------------------------+-------------------+---------------------------------------------+-------------------+--------------------+--------+---------------+--------+-------------+-------------------+------------------+---------------------+---------------------+---------------------+---------------------+--------------+----------------------------+----------+------------+-----------+
   | TENANT_ID | TENANT_NAME | TENANT_TYPE | CREATE_TIME                | MODIFY_TIME                | PRIMARY_ZONE      | LOCALITY                                    | PREVIOUS_LOCALITY | COMPATIBILITY_MODE | STATUS | IN_RECYCLEBIN | LOCKED | TENANT_ROLE | SWITCHOVER_STATUS | SWITCHOVER_EPOCH | SYNC_SCN            | REPLAYABLE_SCN      | READABLE_SCN        | RECOVERY_UNTIL_SCN  | LOG_MODE     | ARBITRATION_SERVICE_STATUS | UNIT_NUM | COMPATIBLE | MAX_LS_ID |
   +-----------+-------------+-------------+----------------------------+----------------------------+-------------------+---------------------------------------------+-------------------+--------------------+--------+---------------+--------+-------------+-------------------+------------------+---------------------+---------------------+---------------------+---------------------+--------------+----------------------------+----------+------------+-----------+
   |      1006 | mysql001    | USER        | 2023-09-25 17:06:51.025654 | 2023-09-25 17:26:00.072130 | zone1,zone2;zone3 | FULL{1}@zone1, FULL{1}@zone2, FULL{1}@zone3 | NULL              | MYSQL              | NORMAL | NO            | NO     | PRIMARY     | NORMAL            |                0 | 1695634420875364980 | 1695634420875364980 | 1695634420875364980 | 4611686018427387903 | NOARCHIVELOG | DISABLED                   |        2 | 4.2.1.0    |      1004 |
   +-----------+-------------+-------------+----------------------------+----------------------------+-------------------+---------------------------------------------+-------------------+--------------------+--------+---------------+--------+-------------+-------------------+------------------+---------------------+---------------------+---------------------+---------------------+--------------+----------------------------+----------+------------+-----------+
   1 row in set
   ```

8. 查询租户 `mysql001` 的 Unit 信息，变更前后 `unit num` 保持不变。

   ```sql
   SELECT * FROM oceanbase.DBA_OB_UNITS WHERE tenant_id = 1006;
   ```

   查询结果如下：

   ```shell
   +---------+-----------+--------+------------------+---------------+----------------------------+----------------------------+-------+----------------+----------+---------------------+-----------------------+----------------+----------------+---------+---------+-------------+---------------+---------------------+---------------------+-------------+
   | UNIT_ID | TENANT_ID | STATUS | RESOURCE_POOL_ID | UNIT_GROUP_ID | CREATE_TIME                | MODIFY_TIME                | ZONE  | SVR_IP         | SVR_PORT | MIGRATE_FROM_SVR_IP | MIGRATE_FROM_SVR_PORT | MANUAL_MIGRATE | UNIT_CONFIG_ID | MAX_CPU | MIN_CPU | MEMORY_SIZE | LOG_DISK_SIZE | MAX_IOPS            | MIN_IOPS            | IOPS_WEIGHT |
   +---------+-----------+--------+------------------+---------------+----------------------------+----------------------------+-------+----------------+----------+---------------------+-----------------------+----------------+----------------+---------+---------+-------------+---------------+---------------------+---------------------+-------------+
   |    1016 |      1006 | ACTIVE |             1003 |          1006 | 2023-09-25 17:06:38.569419 | 2023-09-25 17:06:51.030929 | zone1 | xxx.xx.xxx.194 |     2882 | NULL                |                  NULL | NULL           |           1002 |       1 |       1 |  5368709120 |   16106127360 | 9223372036854775807 | 9223372036854775807 |           1 |
   |    1017 |      1006 | ACTIVE |             1003 |          1007 | 2023-09-25 17:06:38.571540 | 2023-09-25 17:06:51.030929 | zone1 | xxx.xx.xxx.198 |     2882 | NULL                |                  NULL | NULL           |           1002 |       1 |       1 |  5368709120 |   16106127360 | 9223372036854775807 | 9223372036854775807 |           1 |
   |    1018 |      1006 | ACTIVE |             1003 |          1006 | 2023-09-25 17:06:38.573614 | 2023-09-25 17:06:51.030929 | zone2 | xxx.xx.xxx.192 |     2882 | NULL                |                  NULL | NULL           |           1002 |       1 |       1 |  5368709120 |   16106127360 | 9223372036854775807 | 9223372036854775807 |           1 |
   |    1019 |      1006 | ACTIVE |             1003 |          1007 | 2023-09-25 17:06:38.575723 | 2023-09-25 17:06:51.030929 | zone2 | xxx.xx.xxx.196 |     2882 | NULL                |                  NULL | NULL           |           1002 |       1 |       1 |  5368709120 |   16106127360 | 9223372036854775807 | 9223372036854775807 |           1 |
   |    1020 |      1006 | ACTIVE |             1003 |          1006 | 2023-09-25 17:06:38.579946 | 2023-09-25 17:06:51.031986 | zone3 | xxx.xx.xxx.204 |     2882 | NULL                |                  NULL | NULL           |           1002 |       1 |       1 |  5368709120 |   16106127360 | 9223372036854775807 | 9223372036854775807 |           1 |
   |    1021 |      1006 | ACTIVE |             1003 |          1007 | 2023-09-25 17:06:38.581002 | 2023-09-25 17:06:51.031986 | zone3 | xxx.xx.xxx.197 |     2882 | NULL                |                  NULL | NULL           |           1002 |       1 |       1 |  5368709120 |   16106127360 | 9223372036854775807 | 9223372036854775807 |           1 |
   +---------+-----------+--------+------------------+---------------+----------------------------+----------------------------+-------+----------------+----------+---------------------+-----------------------+----------------+----------------+---------+---------+-------------+---------------+---------------------+---------------------+-------------+
   6 rows in set
   ```

通过上述示例，将租户 `mysql001` 的 Primary Zone 的 Zone 个数从 1 变更为 2。变更前租户在每个 Zone 的 Unit 个数为 2；变更后租户在每个 Zone 的 Unit 个数保持不变，但 Primary Zone 个数从 1 变更为 2，从而实现了租户扩容。

## 减少 Primary Zone

1. 使用 `root` 用户登录到集群的 `sys` 租户。

    ```shell
    obclient -h172.30.xxx.xxx -P2883 -uroot@sys#obdemo -pxxxx -A
    ```

2. 进入 `oceanbase` 数据库。

    ```sql
    use oceanbase;
    ```

3. 查询租户 `mysql001` 的基本信息，例如 `locality`、`primary zone` 等属性。

   ```sql
   SELECT * FROM oceanbase.DBA_OB_TENANTS WHERE tenant_id = 1006;
   ```

   查询结果如下：

   ```shell
   +-----------+-------------+-------------+----------------------------+----------------------------+-------------------+---------------------------------------------+-------------------+--------------------+--------+---------------+--------+-------------+-------------------+------------------+---------------------+---------------------+---------------------+---------------------+--------------+----------------------------+----------+------------+-----------+
   | TENANT_ID | TENANT_NAME | TENANT_TYPE | CREATE_TIME                | MODIFY_TIME                | PRIMARY_ZONE      | LOCALITY                                    | PREVIOUS_LOCALITY | COMPATIBILITY_MODE | STATUS | IN_RECYCLEBIN | LOCKED | TENANT_ROLE | SWITCHOVER_STATUS | SWITCHOVER_EPOCH | SYNC_SCN            | REPLAYABLE_SCN      | READABLE_SCN        | RECOVERY_UNTIL_SCN  | LOG_MODE     | ARBITRATION_SERVICE_STATUS | UNIT_NUM | COMPATIBLE | MAX_LS_ID |
   +-----------+-------------+-------------+----------------------------+----------------------------+-------------------+---------------------------------------------+-------------------+--------------------+--------+---------------+--------+-------------+-------------------+------------------+---------------------+---------------------+---------------------+---------------------+--------------+----------------------------+----------+------------+-----------+
   |      1006 | mysql001    | USER        | 2023-09-25 17:06:51.025654 | 2023-09-25 17:26:00.072130 | zone1,zone2;zone3 | FULL{1}@zone1, FULL{1}@zone2, FULL{1}@zone3 | NULL              | MYSQL              | NORMAL | NO            | NO     | PRIMARY     | NORMAL            |                0 | 1695634420875364980 | 1695634420875364980 | 1695634420875364980 | 4611686018427387903 | NOARCHIVELOG | DISABLED                   |        2 | 4.2.1.0    |      1004 |
   +-----------+-------------+-------------+----------------------------+----------------------------+-------------------+---------------------------------------------+-------------------+--------------------+--------+---------------+--------+-------------+-------------------+------------------+---------------------+---------------------+---------------------+---------------------+--------------+----------------------------+----------+------------+-----------+
   1 row in set
   ```

4. 查询租户 `mysql001` 的 Unit 信息，在单个 Zone 的 `unit num` 为 2。

   ```sql
   SELECT * FROM oceanbase.DBA_OB_UNITS WHERE tenant_id = 1006;
   ```

   查询结果如下：

   ```shell
   +---------+-----------+--------+------------------+---------------+----------------------------+----------------------------+-------+----------------+----------+---------------------+-----------------------+----------------+----------------+---------+---------+-------------+---------------+---------------------+---------------------+-------------+
   | UNIT_ID | TENANT_ID | STATUS | RESOURCE_POOL_ID | UNIT_GROUP_ID | CREATE_TIME                | MODIFY_TIME                | ZONE  | SVR_IP         | SVR_PORT | MIGRATE_FROM_SVR_IP | MIGRATE_FROM_SVR_PORT | MANUAL_MIGRATE | UNIT_CONFIG_ID | MAX_CPU | MIN_CPU | MEMORY_SIZE | LOG_DISK_SIZE | MAX_IOPS            | MIN_IOPS            | IOPS_WEIGHT |
   +---------+-----------+--------+------------------+---------------+----------------------------+----------------------------+-------+----------------+----------+---------------------+-----------------------+----------------+----------------+---------+---------+-------------+---------------+---------------------+---------------------+-------------+
   |    1016 |      1006 | ACTIVE |             1003 |          1006 | 2023-09-25 17:06:38.569419 | 2023-09-25 17:06:51.030929 | zone1 | xxx.xx.xxx.194 |     2882 | NULL                |                  NULL | NULL           |           1002 |       1 |       1 |  5368709120 |   16106127360 | 9223372036854775807 | 9223372036854775807 |           1 |
   |    1017 |      1006 | ACTIVE |             1003 |          1007 | 2023-09-25 17:06:38.571540 | 2023-09-25 17:06:51.030929 | zone1 | xxx.xx.xxx.198 |     2882 | NULL                |                  NULL | NULL           |           1002 |       1 |       1 |  5368709120 |   16106127360 | 9223372036854775807 | 9223372036854775807 |           1 |
   |    1018 |      1006 | ACTIVE |             1003 |          1006 | 2023-09-25 17:06:38.573614 | 2023-09-25 17:06:51.030929 | zone2 | xxx.xx.xxx.192 |     2882 | NULL                |                  NULL | NULL           |           1002 |       1 |       1 |  5368709120 |   16106127360 | 9223372036854775807 | 9223372036854775807 |           1 |
   |    1019 |      1006 | ACTIVE |             1003 |          1007 | 2023-09-25 17:06:38.575723 | 2023-09-25 17:06:51.030929 | zone2 | xxx.xx.xxx.196 |     2882 | NULL                |                  NULL | NULL           |           1002 |       1 |       1 |  5368709120 |   16106127360 | 9223372036854775807 | 9223372036854775807 |           1 |
   |    1020 |      1006 | ACTIVE |             1003 |          1006 | 2023-09-25 17:06:38.579946 | 2023-09-25 17:06:51.031986 | zone3 | xxx.xx.xxx.204 |     2882 | NULL                |                  NULL | NULL           |           1002 |       1 |       1 |  5368709120 |   16106127360 | 9223372036854775807 | 9223372036854775807 |           1 |
   |    1021 |      1006 | ACTIVE |             1003 |          1007 | 2023-09-25 17:06:38.581002 | 2023-09-25 17:06:51.031986 | zone3 | xxx.xx.xxx.197 |     2882 | NULL                |                  NULL | NULL           |           1002 |       1 |       1 |  5368709120 |   16106127360 | 9223372036854775807 | 9223372036854775807 |           1 |
   +---------+-----------+--------+------------------+---------------+----------------------------+----------------------------+-------+----------------+----------+---------------------+-----------------------+----------------+----------------+---------+---------+-------------+---------------+---------------------+---------------------+-------------+
   6 rows in set
   ```

5. 修改租户 `mysql001` 的 `PRIMARY_ZONE` 属性，第一优先级 Zone 的个数从 2 调整为 1。

   ```sql
   ALTER TENANT mysql001 PRIMARY_ZONE='zone1;zone2,zone3'; 
   ```

6. 查看减少 Primary Zone 任务的执行状态。

   ```sql
   SELECT * FROM oceanbase.DBA_OB_TENANT_JOBS WHERE JOB_TYPE='ALTER_TENANT_PRIMARY_ZONE' AND tenant_id = 1006;
   ```

   查询结果如下：

   ```shell
   +--------+---------------------------+------------+-------------+----------+----------------------------+----------------------------+-----------+--------------------------------------------------------+-------------------+----------------+-------------+
   | JOB_ID | JOB_TYPE                  | JOB_STATUS | RESULT_CODE | PROGRESS | START_TIME                 | MODIFY_TIME                | TENANT_ID | SQL_TEXT                                               | EXTRA_INFO        | RS_SVR_IP      | RS_SVR_PORT |
   +--------+---------------------------+------------+-------------+----------+----------------------------+----------------------------+-----------+--------------------------------------------------------+-------------------+----------------+-------------+
   |      4 | ALTER_TENANT_PRIMARY_ZONE | SUCCESS    |           0 |      100 | 2023-09-25 17:26:00.069089 | 2023-09-25 17:26:20.919021 |      1006 | ALTER TENANT mysql001 PRIMARY_ZONE='zone1,zone2;zone3' | zone1;zone2;zone3 | xxx.xx.xxx.196 |        2882 |
   |      5 | ALTER_TENANT_PRIMARY_ZONE | SUCCESS    |           0 |      100 | 2023-09-25 17:41:44.412459 | 2023-09-25 17:41:54.965873 |      1006 | ALTER TENANT mysql001 PRIMARY_ZONE='zone1;zone2,zone3' | zone1,zone2;zone3 | xxx.xx.xxx.196 |        2882 |
   +--------+---------------------------+------------+-------------+----------+----------------------------+----------------------------+-----------+--------------------------------------------------------+-------------------+----------------+-------------+
   2 rows in set
   ```

   查询结果中，根据以下字段，找到对应的任务记录：

   * `START_TIME`：任务的发起时间。
   * `SQL_TEXT`：任务对应的 SQL 语句。
   * `EXTRA_INFO`：变更前后的 Primary Zone 信息。

   当对应任务记录中 `JOB_STATUS` 的值为 `SUCCESS` 时，表示减少 Primary Zone 的任务执行成功。

   有关视图 `DBA_OB_TENANT_JOBS` 的详细字段说明，请参见 [DBA_OB_TENANT_JOBS](../../../../700.reference/700.system-views/300.system-view-of-sys-tenant/200.dictionary-view-of-sys-tenant/5700.oceanbase-dba_ob_tenant_jobs-of-sys-tenant.md)。

7. 查询租户 `mysql001` 的基本信息，确认 `PRIMARY_ZONE` 属性修改成功，由 `zone1,zone2` 变更为 `zone1`。

   ```sql
   SELECT * FROM oceanbase.DBA_OB_TENANTS WHERE tenant_id = 1006;
   ```

   查询结果如下：

   ```shell
   +-----------+-------------+-------------+----------------------------+----------------------------+-------------------+---------------------------------------------+-------------------+--------------------+--------+---------------+--------+-------------+-------------------+------------------+---------------------+---------------------+---------------------+---------------------+--------------+----------------------------+----------+------------+-----------+
   | TENANT_ID | TENANT_NAME | TENANT_TYPE | CREATE_TIME                | MODIFY_TIME                | PRIMARY_ZONE      | LOCALITY                                    | PREVIOUS_LOCALITY | COMPATIBILITY_MODE | STATUS | IN_RECYCLEBIN | LOCKED | TENANT_ROLE | SWITCHOVER_STATUS | SWITCHOVER_EPOCH | SYNC_SCN            | REPLAYABLE_SCN      | READABLE_SCN        | RECOVERY_UNTIL_SCN  | LOG_MODE     | ARBITRATION_SERVICE_STATUS | UNIT_NUM | COMPATIBLE | MAX_LS_ID |
   +-----------+-------------+-------------+----------------------------+----------------------------+-------------------+---------------------------------------------+-------------------+--------------------+--------+---------------+--------+-------------+-------------------+------------------+---------------------+---------------------+---------------------+---------------------+--------------+----------------------------+----------+------------+-----------+
   |      1006 | mysql001    | USER        | 2023-09-25 17:06:51.025654 | 2023-09-25 17:41:44.412137 | zone1;zone2,zone3 | FULL{1}@zone1, FULL{1}@zone2, FULL{1}@zone3 | NULL              | MYSQL              | NORMAL | NO            | NO     | PRIMARY     | NORMAL            |                0 | 1695634988660461888 | 1695634988660461888 | 1695634988660461888 | 4611686018427387903 | NOARCHIVELOG | DISABLED                   |        2 | 4.2.1.0    |      1004 |
   +-----------+-------------+-------------+----------------------------+----------------------------+-------------------+---------------------------------------------+-------------------+--------------------+--------+---------------+--------+-------------+-------------------+------------------+---------------------+---------------------+---------------------+---------------------+--------------+----------------------------+----------+------------+-----------+
   1 row in set
   ```

8. 再次查询租户 `mysql001` 的 Unit 信息，变更前后 `unit num` 保持不变。

   ```sql
   SELECT * FROM oceanbase.DBA_OB_UNITS WHERE tenant_id = 1006;
   ```

   查询结果如下：

   ```shell
   +---------+-----------+--------+------------------+---------------+----------------------------+----------------------------+-------+----------------+----------+---------------------+-----------------------+----------------+----------------+---------+---------+-------------+---------------+---------------------+---------------------+-------------+
   | UNIT_ID | TENANT_ID | STATUS | RESOURCE_POOL_ID | UNIT_GROUP_ID | CREATE_TIME                | MODIFY_TIME                | ZONE  | SVR_IP         | SVR_PORT | MIGRATE_FROM_SVR_IP | MIGRATE_FROM_SVR_PORT | MANUAL_MIGRATE | UNIT_CONFIG_ID | MAX_CPU | MIN_CPU | MEMORY_SIZE | LOG_DISK_SIZE | MAX_IOPS            | MIN_IOPS            | IOPS_WEIGHT |
   +---------+-----------+--------+------------------+---------------+----------------------------+----------------------------+-------+----------------+----------+---------------------+-----------------------+----------------+----------------+---------+---------+-------------+---------------+---------------------+---------------------+-------------+
   |    1016 |      1006 | ACTIVE |             1003 |          1006 | 2023-09-25 17:06:38.569419 | 2023-09-25 17:06:51.030929 | zone1 | xxx.xx.xxx.194 |     2882 | NULL                |                  NULL | NULL           |           1002 |       1 |       1 |  5368709120 |   16106127360 | 9223372036854775807 | 9223372036854775807 |           1 |
   |    1017 |      1006 | ACTIVE |             1003 |          1007 | 2023-09-25 17:06:38.571540 | 2023-09-25 17:06:51.030929 | zone1 | xxx.xx.xxx.198 |     2882 | NULL                |                  NULL | NULL           |           1002 |       1 |       1 |  5368709120 |   16106127360 | 9223372036854775807 | 9223372036854775807 |           1 |
   |    1018 |      1006 | ACTIVE |             1003 |          1006 | 2023-09-25 17:06:38.573614 | 2023-09-25 17:06:51.030929 | zone2 | xxx.xx.xxx.192 |     2882 | NULL                |                  NULL | NULL           |           1002 |       1 |       1 |  5368709120 |   16106127360 | 9223372036854775807 | 9223372036854775807 |           1 |
   |    1019 |      1006 | ACTIVE |             1003 |          1007 | 2023-09-25 17:06:38.575723 | 2023-09-25 17:06:51.030929 | zone2 | xxx.xx.xxx.196 |     2882 | NULL                |                  NULL | NULL           |           1002 |       1 |       1 |  5368709120 |   16106127360 | 9223372036854775807 | 9223372036854775807 |           1 |
   |    1020 |      1006 | ACTIVE |             1003 |          1006 | 2023-09-25 17:06:38.579946 | 2023-09-25 17:06:51.031986 | zone3 | xxx.xx.xxx.204 |     2882 | NULL                |                  NULL | NULL           |           1002 |       1 |       1 |  5368709120 |   16106127360 | 9223372036854775807 | 9223372036854775807 |           1 |
   |    1021 |      1006 | ACTIVE |             1003 |          1007 | 2023-09-25 17:06:38.581002 | 2023-09-25 17:06:51.031986 | zone3 | xxx.xx.xxx.197 |     2882 | NULL                |                  NULL | NULL           |           1002 |       1 |       1 |  5368709120 |   16106127360 | 9223372036854775807 | 9223372036854775807 |           1 |
   +---------+-----------+--------+------------------+---------------+----------------------------+----------------------------+-------+----------------+----------+---------------------+-----------------------+----------------+----------------+---------+---------+-------------+---------------+---------------------+---------------------+-------------+
   6 rows in set
   ```

通过上述示例，将租户 `mysql001` 的 Primary Zone 的 Zone 个数从 2 变更为 1。变更前租户在每个 Zone 的 Unit 个数为 2；变更后租户在每个 Zone 的 Unit 个数保持不变，但 Primary Zone 个数从 2 变更为 1，从而实现了租户缩容。
