|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# 关闭归档模式

开启归档模式后，也可以用相同的方式关闭归档模式。若租户在关闭归档模式之前，有正在进行或者暂停的日志归档任务，关闭归档模式后，系统会自动停止这些归档任务。

<main id="notice" type='notice'>
  <h4>注意</h4>
  <p>为防止归档任务状态卡在 STOPPING 状态无法关闭，当归档介质不可用时也能够正常关闭归档任务。相应地，日志消费模块也能够在强关归档的场景下正确消费日志。</p>
</main>

## 背景信息

假设当前集群中有 3 个租户，分别是 `sys`、`mysql_tenant` 和 `oracle_tenant`，且租户 `mysql_tenant` 和 `oracle_tenant` 均已开启归档模式。

## 系统租户为其他租户关闭归档模式

`sys` 租户可以关闭集群中所有租户或指定租户的归档模式。

1. 使用 `root` 用户登录集群的 `sys` 租户。

2. 执行以下语句，关闭归档模式。

   * 关闭集群中所有租户的归档模式

     该方式会关闭集群中所有租户的归档模式。

     ```shell
     obclient [(none)]> ALTER SYSTEM NOARCHIVELOG [TENANT = ALL];
     ```

     命令执行成功后，在本示例中，`mysql_tenant` 和 `oracle_tenant` 都会关闭归档模式。可以通过 `sys` 租户下的 `oceanbase.DBA_OB_TENANTS` 视图查看集群中所有租户的归档模式。

     ```shell
     obclient [(none)]> SELECT TENANT_NAME, LOG_MODE FROM oceanbase.DBA_OB_TENANTS WHERE TENANT_TYPE='USER'\G
     *************************** 1. row ***************************
     TENANT_NAME: mysql_tenant
        LOG_MODE: NOARCHIVELOG
     *************************** 2. row ***************************
     TENANT_NAME: oracle_tenant
        LOG_MODE: NOARCHIVELOG
     2 rows in set
     ```

   * 关闭集群中指定租户的归档模式

     该方式仅会关闭指定租户的归档模式，不会影响集群中的其他租户。

     ```shell
     obclient [(none)]> ALTER SYSTEM NOARCHIVELOG TENANT = mysql_tenant;
     ```

     <main id="notice" type='explain'>
     <h4>说明</h4>
     <p>同时指定多个租户时，租户名之间使用英文逗号 (`,`) 分隔。</p>
     </main>

     命令执行成功后，在本示例中，`mysql_tenant` 会关闭归档模式。可以通过租户下的 `oceanbase.DBA_OB_TENANTS` 视图查看集群中所有租户的归档模式。

     ```shell
     obclient [(none)]> SELECT TENANT_NAME, LOG_MODE FROM oceanbase.DBA_OB_TENANTS WHERE TENANT_TYPE = 'USER'\G
     *************************** 1. row ***************************
     TENANT_NAME: mysql_tenant
        LOG_MODE: NOARCHIVELOG
     *************************** 2. row ***************************
     TENANT_NAME: oracle_tenant
        LOG_MODE: ARCHIVELOG
     2 rows in set
     ```

## 用户租户为本租户关闭归档模式

用户租户也可以直接关闭本租户的归档模式，不会影响其他租户。

1. 租户管理员登录到数据库。

   本示例中，您可以使用 `root` 用户登录 `mysql_tenant` 租户；或者也可以使用 `SYS` 用户登录 `oracle_tenant` 租户。

2. 执行以下语句，关闭归档模式。

    ```shell
    obclient [xxx]> ALTER SYSTEM NOARCHIVELOG;
    ```

   命令执行成功后，可以直接通过该租户下的 `DBA_OB_TENANTS` 视图查看该租户所处的归档模式。

   ```shell
   obclient [SYS]> SELECT TENANT_NAME, LOG_MODE FROM DBA_OB_TENANTS\G
   *************************** 1. row ***************************
   TENANT_NAME: oracle_tenant
      LOG_MODE: NOARCHIVELOG
   1 rows in set
   ```

## 相关文档

* [查看归档进度](../300.log-archive/600.view-log-archive-progress.md)
* [查看归档历史](../300.log-archive/700.view-log-archive-history.md)
