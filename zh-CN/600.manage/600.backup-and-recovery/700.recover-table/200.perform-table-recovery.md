|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# 执行按表恢复

本节主要介绍如何进行按表恢复。

## 使用限制

* 仅支持恢复用户表，不支持单独恢复临时表、视图、索引等。

* 不支持恢复表上的外键、触发器及统计信息等。

* 表恢复的源租户与目标租户的兼容性必须一致，例如，均为 Oracle 兼容性租户，或者均为 MySQL 兼容性租户。

* 恢复表时，指定的表名需要与系统实际存储的表名一致。例如，Oracle 模式租户下创建表 `test`，而系统内部实际存储的表名为 `TEST`，故在恢复表时需要指定表名为 `TEST`，否则系统会报错，提示表不存在。

* 与租户级恢复一样，表级恢复当前也是仅支持将低版本的备份数据中的表恢复到同版本或高版本中，同版本下的小版本之间也不支持逆向恢复。

## 前提条件

由于指定表的恢复过程中需要使用辅助租户，因此，在进行表恢复前，您需要在目标租户所在的集群内为辅助租户创建所需的资源池。为辅助租户创建所需资源池的详细操作，请参见 [按表恢复前准备](100.preparation-before-table-recovery.md)。

## 操作步骤

1. 使用 `root` 用户登录目标租户所在集群的 `sys` 租户。

2. （可选）如果恢复指定的表时所使用的备份数据配置了加密功能，则需要配置备份集的加密信息。

   仅在数据备份时添加了密码的场景下才需要设置备份的恢复密码。

   ```sql
   SET DECRYPTION IDENTIFIED BY 'password';
   ```

   其中，`password` 需要替换为备份时添加的密码。如果全量备份和增量备份设置的密码不一样，则需要输入多个密码，密码之间使用英文逗号分隔（全量备份密码放在前面，增量备份密码放在后面）。

   全量备份和增量备份设置的密码相同时的示例如下：

   ```sql
   SET DECRYPTION IDENTIFIED BY '******';
   ```

   全量备份和增量备份设置的密码不一样时的示例如下：

   ```sql
   SET DECRYPTION IDENTIFIED BY '******','******';
   ```

4. （可选）设置表级恢复并行度

在执行多表表级恢复之前，可通过配置项 [recover_table_concurrency](../../../700.reference/800.configuration-items-and-system-variables/100.system-configuration-items/400.tenant-level-configuration-items/9100.recover_table_concurrency.md) 设置并发度。设置后多个表能够并行执行恢复任务，提升恢复性能。

<main id="notice" type='notice'>
  <h4>注意</h4>
  <ul><li>控制阶段：<ul><li>该参数只控制<b>跨租户导表阶段</b>的并行度。</li><li>执行命令中 `restore_option` 中的可选参数 `concurrency` 只控制<b>物理恢复阶段</b>的并行度。表级恢复流程说明请参见<a href="../../../700.reference/100.oceanbase-database-concepts/1000.high-data-reliability-and-availability/500.backup-and-recovery/400.recovery-architecture.md">恢复流程</a>。</li></ul><li>动态调整：<ul><li>允许在表级恢复执行过程中，可通过调整 `recover_table_concurrency` 配置项来实现<b>跨租户导表阶段</b>的并行度动态调整，设置动态生效。</li><li>在辅助租户的 Meta 租户创建成功后，可通过调整配置项 <a href="../../../700.reference/800.configuration-items-and-system-variables/100.system-configuration-items/400.tenant-level-configuration-items/3500.ha_high_thread_score.md">ha_high_thread_score</a> 来实现<b>物理恢复阶段</b>的并行度动态调整，设置动态生效。</li></ul>
</main>

```sql
-- tenant_name 为目标租户
ALTER SYSTEM SET recover_table_concurrency=INT_VALUE tenant=tenant_name;
```

5. 执行以下命令，恢复指定的表。

   语法如下：

   ```sql
   ALTER SYSTEM 
   RECOVER TABLE table_name_list 
   TO [TENANT [=]] dest_tenant_name 
   FROM uri 
   [UNTIL {TIME='timestamp'} | {SCN=scn} ]
   WITH 'restore_option' 
   [WITH KEY FROM 'backup_key_path' ENCRYPTED BY 'password']
   [REMAP TABLE remap_table_name_list] 
   [REMAP TABLEGROUP remap_tablegroup_list] 
   [REMAP TABLESPACE remap_tablespace_list]
   [DESCRIPTION [=] description];
   ```

   参数详细说明请参见 [按表恢复相关参数介绍](600.parameters-of-the-table-recovery.md)。

   假设将 `infodb` 库中的表 `tbl1`、`tbl2` 恢复到目标租户的 `infodb` 库中，并且将表 `tbl1` 重命名为 `newtbl`，同时将表所属的表组重定向为 `newtg1`，表所属的表空间重定向为 `newts1`。示例如下：

   ```sql
   ALTER SYSTEM 
   RECOVER TABLE infodb.tbl1,infodb.tbl2 
   TO TENANT oracle001 
   FROM 'file:///data/nfs/backup/data,file:///data/nfs/backup/archive' 
   UNTIL TIME='2023-09-30 00:00:00' 
   WITH 'pool_list=restore_pool'
   REMAP TABLE infodb.tbl1:newtbl 
   REMAP TABLEGROUP tg1:newtg1
   REMAP TABLESPACE ts1:newts1;
   ```

  <main id="notice" type='notice'>
  <h4>注意</h4>
  <p>表数据恢复成功即表示表恢复成功，允许索引、约束或其他关联的 Schema 恢复失败。</p>
  </main>   

## 后续操作

* 发起指定表的恢复后，您可以通过视图查看表恢复的进度和结果，具体操作请参见 [查看按表恢复的进度](400.view-the-table-recovery-progress.md)。

* 指定表的恢复结束后，您还需要在辅助租户所在的集群中执行以下命令，手动释放为辅助租户创建的资源池。

    ```sql
    DROP RESOURCE POOL restore_pool;
    ```

    其中，`restore_pool` 表示在恢复前准备时为辅助租户创建的资源池名。

    有关删除资源池的详细操作及介绍，请参见 [删除资源池](../../200.tenant-management/600.common-tenant-operations/1500.resource-pool-management/600.delete-resource-pool.md)。