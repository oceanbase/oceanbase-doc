| Description   |                 |
|---------------|-----------------|
| keywords      |                 |
| dir-name      |                 |
| dir-name-en   |                 |
| tenant-type   |                 |

# 存储层估行

我们知道统计信息收集是发生在计划生成之前的，因此如果在收集完统计信息之后，又发生了大量的增删改操作，但是又没有及时的重新收集统计信息，这个时候就会可能导致计划生成因为使用了过期的统计信息而不能准确的估算行数，从而不能选择到最优的执行计划。因此，为了解决这类问题，OceanBase 数据库优化器支持了实时的存储层估行机制，以获得更加实时准确的统计信息。

计划生成的时候，会基于表的索引生成多条基表的扫描路径，简称“基表路径”；由于 OceanBase 数据库存储层针对索引都是以树形结构存在，因此在计划生成的时候会针对每一个基表路径都会基于表的谓词条件生成多个查询范围区域（简称“QUERY RANGE”），以便快速扫描获取指定的数据区域，避免无效的数据扫描。因此，基于这个特点，OceanBase 数据库优化器会在计划生成的时候，把基表路径上的相关 QUERY RANGE 提前发给存储层，存储层快速的估算 QUERY RANGE 的总行数返回给优化器。从而优化器就能得到一个实时准确的行数，这一过程就是存储层估行。

但是并不是所有的 QUERY RANGE 与分区都会用于存储层估行的，由于存储层估行其实也是比较耗时的操作，为了计划生成的整体时间耗时考虑，对于存储层估行做了以下两个限制:

* 基表路径上的 QUERY RANGE 个数不能太多，在个数超过系统变量 `range_index_dive_limit` 时，仅随机选择其中相应系统变量个数的 QUERY RANGE 进行存储层估行。
* 分区表裁剪后的分区个数不能太多，在个数超过系统变量 `partition_index_dive_limit` 时，仅随机选择其中相应系统变量个数的分区进行存储层估行。

需要注意的是，存储层估行仅仅应用于基表路径上，并不适用于其他算子，比如 JOIN/GROUP BY 等等。
