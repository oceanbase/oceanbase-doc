| Description   |                 |
|---------------|-----------------|
| keywords      |                 |
| dir-name      |                 |
| dir-name-en   |                 |
| tenant-type   |                 |

# 选择率估行

选择率的含义是在经过谓词条件后返回的行数和未经过谓词条件的返回行数的比例。显而易见，选择率的取值范围是 0～1，值越小，就表明可选择性越好，选择率为 1 时的可选择性是最差的。OceanBase 数据库优化器会基于统计信息和选择率计算规则计算得到谓词的选择率，然后再进行行数估计。

比如下面的例子：

```
obclient [TEST]>create table t1(c1 int, c2 int, c3 int);
Query OK, 0 rows affected (0.09 sec)
```

```
obclient [TEST]>insert into t1 select mod(level,10),mod(level,100),mod(level,1000) from dual connect by level<=1000;
Query OK, 1000 rows affected (0.03 sec)
Records: 1000  Duplicates: 0  Warnings: 0
```

```
obclient [TEST]>call dbms_stats.gather_table_stats('TEST','T1');
Query OK, 0 rows affected (0.48 sec)
```

```
obclient [TEST]>select NUM_DISTINCT,LOW_VALUE,HIGH_VALUE from sys.dba_tab_col_statistics where owner = 'TEST' and table_name='T1';
+--------------+-----------+------------+
| NUM_DISTINCT | LOW_VALUE | HIGH_VALUE |
+--------------+-----------+------------+
|           10 | 0         | 9          |
|          101 | 0         | 99         |
|         1031 | 0         | 999        |
+--------------+-----------+------------+
3 rows in set (0.19 sec)
```

通过收集统计信息之后，查询相关视图可以查询到 `c1` 列的 `NDV` 为 10，因此针对查询 Q1：`select * from t1 where c1 = 10`，中 `c1 = 10` 的选择率为：`1/10 = 0.1`；因此估算的行数为：`1000 * 1/10 = 100`；通过下面计划展示进行验证：

```shell
-- Q1
obclient [TEST]>explain select * from t1 where c1 = 10;
+------------------------------------------------------------------------------------+
| Query Plan                                                                         |
+------------------------------------------------------------------------------------+
| ===============================================                                    |
| |ID|OPERATOR       |NAME|EST.ROWS|EST.TIME(us)|                                    |
| -----------------------------------------------                                    |
| |0 |TABLE FULL SCAN|t1  |100     |60          |                                    |
| ===============================================                                    |
| Outputs & filters:                                                                 |
| -------------------------------------                                              |
|   0 - output([t1.c1], [t1.c2], [t1.c3]), filter([t1.c1 = 10]), rowset=256          |
|       access([t1.c1], [t1.c2], [t1.c3]), partitions(p0)                            |
|       is_index_back=false, is_global_index=false, filter_before_indexback[false],  |
|       range_key([t1.__pk_increment]), range(MIN ; MAX)always true                  |
+------------------------------------------------------------------------------------+
11 rows in set
```

类似的，针对查询 Q2：`select * from t1 where c1 = 10 and c2 = 10` 中，在 `cardinality_estimation_model` 为 `partial` 的情况下，Q2 中的两个谓词的选择率为 `1/101 * sqrt( 1/10)`，约为 0.0031，估行结果向上取整为 4。通过下面计划展示进行验证：

```shell
-- Q2
obclient [TEST]>explain select * from t1 where c1 = 10 and c2 = 10;
+------------------------------------------------------------------------------------------+
| Query Plan                                                                               |
+------------------------------------------------------------------------------------------+
| ===============================================                                          |
| |ID|OPERATOR       |NAME|EST.ROWS|EST.TIME(us)|                                          |
| -----------------------------------------------                                          |
| |0 |TABLE FULL SCAN|T1  |4       |63          |                                          |
| ===============================================                                          |
| Outputs & filters:                                                                       |
| -------------------------------------                                                    |
|   0 - output([T1.C1], [T1.C2], [T1.C3]), filter([T1.C2 = 10], [T1.C1 = 10]), rowset=16   |
|       access([T1.C1], [T1.C2], [T1.C3]), partitions(p0)                                  |
|       is_index_back=false, is_global_index=false, filter_before_indexback[false,false],  |
|       range_key([T1.__pk_increment]), range(MIN ; MAX)always true                        |
+------------------------------------------------------------------------------------------+
11 rows in set (0.050 sec)
```

选择率估行目前是 OceanBase 数据库优化器估行的主要手段，计划生成时，相关算子的谓词条件都会基于统计信息计算及其选择率计算规则计算出对应的选择率，最后基于整体的选择率估算行数。
