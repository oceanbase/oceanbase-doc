# 管理集群

在日常运维过程中，您可以对集群进行重启、停止、删除及升级操作。

## 前提条件

> **注意**
>
> 若您选择使用 OBD 对集群进行重启、停止、删除及升级操作，则可以跳过该前提条件。

* 待管理的集群可以在当前 OCP 中进行管理。

  如果该集群未加入到 OCP 中进行管理，请联系管理员将待操作的集群接管到当前 OCP 中，具体操作方法请参见 OCP 对应版本的《用户指南》文档中的 **接管集群** 。

* 在执行集群管理操作前，请确认当前登录用户具备 **CLUSTER_MANAGER** 角色权限。

  如果当前用户没有该角色权限，请联系管理员为您添加，具体操作方法请参见 OCP 对应版本的《用户指南》文档中的 **编辑用户** 。

## 查看集群信息

集群创建成功后，您可以通过视图或 OCP 来查看集群基本信息，包括集群名称、集群 ID，当前集群的角色，集群状态等。

### 通过视图查看集群信息

1. 使用 `root` 用户登录系统的 `sys` 租户。

2. 进入 `oceanbase` 数据库。

   ```sql
   obclient> USE oceanbase;
   ```

3. 执行以下语句，查看集群信息。

   示例如下：

   ```sql
   obclient> select * from v$ob_cluster;
   +------------+--------------+----------------------------+--------------+----------------+-------------+-------------------+-----------------------------+------------------+----------------------------+--------------------+---------------------+---------------------+------------------------------+
   | cluster_id | cluster_name | created                    | cluster_role | cluster_status | switchover# | switchover_status | switchover_info             | current_scn      | standby_became_primary_scn | primary_cluster_id | protection_mode     | protection_level    | redo_transport_options       |
   +------------+--------------+----------------------------+--------------+----------------+-------------+-------------------+-----------------------------+------------------+----------------------------+--------------------+---------------------+---------------------+------------------------------+
   |     100022 | test322_1205 | 2021-12-14 10:23:25.527305 | PRIMARY      | VALID          |           0 | NOT ALLOWED       | NONE SYNCED STANDBY CLUSTER | 1639532540674975 |                          0 |               NULL | MAXIMUM PERFORMANCE | MAXIMUM PERFORMANCE | ASYNC NET_TIMEOUT = 30000000 |
   +------------+--------------+----------------------------+--------------+----------------+-------------+-------------------+-----------------------------+------------------+----------------------------+--------------------+---------------------+---------------------+------------------------------+
   1 row in set
   ```

   更多 `v$ob_cluster` 视图的字段及说明信息，请参见 [v$ob_cluster](../../12.reference-guide/1.system-views/2.performance-views/92.v-ob_cluster.md)。

### 通过 OCP 查看集群信息

1. 登录 OCP。

   默认进入 **集群概览** 页面。

2. 在该页面的 **集群列表** 区域，可以看到当前 OCP 管理中的所有集群的集群名、集群 ID、当前版本、部署模式以及集群状态等信息。

3. 单击待查看的集群名，进入该集群的 总览 页面。

   可以进一步查看该集群所属的集群类型、Region 数量、硬件架构、机器数量等信息。

## 重启集群

集群的重启动作可以细分为每个 Zone 重启，也可以是集群的所有 Zone 一起重启。通常是在更改了某些参数后需要重启生效时执行的操作。

### 注意事项及影响

应确保待重启的 OceanBase 集群为多副本集群，且副本数应大于等于 3，这样 OceanBase 集群会轮转重启，重启过程中业务不停止服务。若待重启的 OceanBase 集群的副本数小于 3，则重启集群时会停业务服务，请谨慎操作。

### 操作步骤

1. 登录 OCP 。

   默认进入 **集群概览** 页面。

2. 在该页面的 **集群列表** 区域，选择待操作的集群并单击其集群名。

3. 单击 **总览** 页面的右上角图标，选择 **重启集群** 。

4. 选择 **重启范围** 为 **全部** 、某个 Zone 或某几个 Zone。

   * 如果选择了 **全部** ，则系统会重启集群中所有节点的 observer 进程。

   * 如果选择的是某些 Zone，则系统会重启这些 Zone 的 observer 进程。

   ![重启](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/3048190061/p168772.png)

5. 单击 **重启** 。

   您可通过弹出框中的 **查看任务** 按钮，查看重启进度。

   您也可在 **系统管理 \> 任务** 中查看该任务的重启进度。

   当任务状态为 **完成** ，且集群 **总览** 页的 **Zone 列表** 中相关 Zone 的状态均为 **运行中** 时，表示重启成功。

   > **说明**
   >
   > 您也可以通过 OBD 提供的 `obd cluster restart <deploy_name>` 命令来重启集群。详细信息请参考 [obd cluster restart](https://www.oceanbase.com/docs/community/obd-cn/V1.3.3/10000000000182177)。

## 停止集群

您可以根据业务需要停止集群，停止集群将会停止集群中所有节点上运行的 observer 进程。

   >注意事项及影响
   >
   >* 选择该 OceanBase 集群业务量少的时间段进行停止集群的操作。
   >
   >* 停止集群会停止当前集群上的所有业务，且目前无法规避停止集群带来的影响，请谨慎操作。目前仅当该集群不再使用时才建议使用该功能。

### 通过 OCP 停止集群

1. 登录 OCP 。

   默认进入 **集群概览** 页面。

2. 在该页面的 **集群列表** 区域，选择待操作的集群并单击其集群名。

3. 在 **总览** 页面的右上角，单击 **...** 图标，选择 **停止集群** 。

   > **注意**
   >
   > 停止集群将会停止集群中所有节点上运行的 observer 进程，请谨慎操作。

4. 在弹出的 **确认** 框中，单击 **停止** 。

   您可通过弹出框中的 **查看任务** 按钮，查看停止进度。

   您也可在 **系统管理 \> 任务** 中查看该任务的停止进度。

   当该任务状态为 **完成** ，且 **集群** 页的 **集群列表** 中，该集群的状态为 **已停止** 时，则集群停止成功。

5. 启动集群。

   集群停止后，如您想再次启用该 OceanBase 集群，可通过集群 **总览** 页右上角的 **启动集群** 按钮，再次启用该集群。

   ![11161438](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/0685987361/p352700.png)

### 通过 OBD 停止集群

1. 在 OBD 所在机器的操作用户下，执行如下命令停止集群：

   ```bash
   obd cluster stop <deploy_name>
   ```

   其中，`deploy_name` 为所需停止的集群名。

2. 执行如下命令查看 OBD 下所有集群的状态：

   ```bash
   obd cluster list
   ```

   显示上一步中停止的集群状态为 `stopped` 说明已成功停止该集群。

3. 您可通过执行如下命令再次启动集群：

   ```bash
   obd cluster start <deploy_name>
   ```

   > **说明**
   >
   > 上述步骤中使用到的 OBD 命令，详细信息请参考 [集群命令组](https://www.oceanbase.com/docs/community/obd-cn/V1.3.3/10000000000182177)。

## 删除集群

### 通过 OCP 删除集群

1. 登录 OCP 。

   默认进入 **集群概览** 页面。

2. 在该页面的 **集群列表** 区域，选择待删除的集群并单击其集群名。

3. 在 **总览** 页面的右上角，单击 **...** 图标，选择 **删除集群** 。

4. 在弹出的 **删除集群** 对话框中，输入 delete。

   ![delete](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/3048190061/p168775.png)

5. 单击 **删除** 。

   您可通过弹出框中的 **查看任务** 按钮，查看进度或失败原因。

   您也可在 **系统管理 \> 任务** 中查看该任务的进度。

   当该任务状态为 **完成** ，且 **集群** 页的 **集群列表** 中无该 OceanBase 集群，则删除成功。

### 通过 OBD 删除集群

1. 在 OBD 所在机器的操作用户下，执行如下命令销毁集群：

   ```bash
   obd cluster destroy <deploy_name> [-f]
   ```

   其中，`deploy_name` 为所需删除的集群名。选项 `-f` 为 `--force-kill`，作用为：检查到工作目录下有运行中的进程时，强制停止。

2. 执行如下命令查看 OBD 下集群的状态：

   ```bash
   obd cluster list
   ```

   显示上一步中销毁的集群状态为 `destroyed` 说明已成功销毁该集群。

3. 也可登录到集群对应的机器上，执行如下命令查看相关进程是否存在：

   ```bash
   ps -ef | grep observer
   ```

   若查询结果显示无相关进程，也表示成功删除该集群。

   > **说明**
   >
   > 上述步骤中使用的到 OBD 命令，详细信息请参考 [集群命令组](https://www.oceanbase.com/docs/community/obd-cn/V1.3.3/10000000000182177)。
