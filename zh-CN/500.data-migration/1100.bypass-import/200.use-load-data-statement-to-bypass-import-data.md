|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# 使用 LOAD DATA 语句旁路导入数据/文件

`LOAD DATA` 语句中，使用 `Hint direct` 指明是否进行旁路导入。

<main id="notice" type='explain'>
<h4>说明</h4>
<ul><li>列式存储表支持旁路导入功能。</li>
<li><code>LOB</code> 类型的列支持旁路导入数据。</li></ul>
</main>

## 使用限制

* 同时只能有一个 `LOAD DATA` 语句操作同一个表，因为会先对表加锁。
* 触发器（Trigger）中不支持使用 `LOAD DATA` 语句。
* `LOAD DATA` 不能在包含多行操作的事务中使用。

## 注意事项

OceanBase 数据库通过并行处理技术优化 `LOAD DATA` 的数据导入速率。该操作将数据分成多个子任务并行执行，每个子任务都视为独立的事务，执行顺序是不固定的。因此：

* 不能保证数据导入过程的全局原子性。
* 对于没有主键的表，数据写入顺序可能与原文件中的顺序不同。

## 语法

- 单文件导入：

```sql
LOAD DATA /*+ direct(need_sort,max_error) parallel(N) */ [REMOTE_OSS | LOCAL] INFILE 'file_name' ...
```

- 多文件导入：

```sql
LOAD DATA /*+ direct(need_sort,max_error) parallel(N) */ [LOCAL] INFILE 'file_name1,file_name2,...' INTO TABLE tbl_name FIELDS [TERMINATED BY 'string'] ...
```

更多 `LOAD DATA` 语法的信息，请参见 [LOAD DATA](../../700.reference/500.sql-reference/100.sql-syntax/200.common-tenant-of-mysql-mode/600.sql-statement-of-mysql-mode/5900.load-data-of-mysql-mode.md)。

**参数解释：**

|参数|描述|
|------|------|
| direct | 表示走旁路导入。|
| REMOTE_OSS \| LOCAL | 可选项，<ul><li> <code>REMOTE_OSS</code> 用于指定是否从 OSS 文件系统读取数据。<main id="notice" type='notice'><h4>注意</h4><p>如果使用了此参数，<code>file_name</code> 必须是一个 OSS 的地址。</p></main>  </li><li> <code>LOCAL</code> 用于指定是否从客户端的本地文件系统读取数据。如果不使用 `LOCAL` 参数，那么将从服务器端（OBServer 节点）的文件系统读取数据。</li></ul> |
| need_sort | 表示是否需要 OceanBase 数据库对数据进行排序。</br>值为 `bool` 类型：<ul><li>`true`：表示需要排序。</li><li>`false`：表示不需要排序。</li></ul>|
| max_error | 表示最大的容忍的错误的行数。值为 `INT` 类型，超过这个数值`LOAD DATA` 会报失败。|
| parallel(N) | 加载数据的并行度，`N` 默认为 `4`。|

## 通配符方式支持多文件导入

在进行旁路数据导入时，来源于云对象存储服务（OSS）的文件只能指定一个；若需导入多个文件，必须分别使用多条 `load data` 语句。对于存储于集群内文件系统（server_disk）的数据文件，应以逗号分隔逐一指定。为便于多文件导入，引入文件通配符功能，适用于 server_disk 和 OSS 类型的文件源，不适用于客户端磁盘（client_disk）。

**集群内文件系统（server_disk）旁路导入使用方法**

- server_disk 示例：

  - 匹配文件名：`load data /*+ parallel(20) direct(true, 0) */ infile '/xxx/test.*.csv' replace into table t1 fields terminated by '|';`

  - 匹配目录：`load data /*+ parallel(20) direct(true, 0) */ infile '/aaa*bb/test.1.csv' replace into table t1 fields terminated by '|';`

  - 同时匹配目录和文件名：`load data /*+ parallel(20) direct(true, 0) */ infile '/aaa*bb/test.*.csv' replace into table t1 fields terminated by '|';`

- server_disk 注意事项：

  - 必须存在至少一个匹配的文件，否则报错 `OB_FILE_NOT_EXIST`。

  - 对 `load data /*+ parallel(20) direct(true, 0) */ infile '/xxx/test.1*.csv,/xxx/test.6*.csv' replace into table t1 fields terminated by '|';` 的输入，`/xxx/test.1*.csv,/xxx/test.6*.csv` 会被认为是整体匹配，若无匹配则报错 `OB_FILE_NOT_EXIST`。

  - 只支持 POSIX 的 GLOB 函数能支持的通配符，例如 `test.6*(6|0).csv` 和 `test.6*({0.csv,6.csv}|.csv)` 尽管可通过 `ls` 命令查找，但 GLOB 函数无法匹配，会报 `OB_FILE_NOT_EXIST`。

**云对象存储服务（OSS）旁路导入使用方法**

- oss 示例：

  - 匹配文件名：`load data /*+ parallel(20) direct(true, 0) */ remote_oss infile 'oss://xxx/test.*.csv?host=xxx&access_id=xxx&access_key=xxx' replace into table t1 fields terminated by '|';`

- oss 注意事项：

  - 不支持目录匹配。例如：`load data /*+ parallel(20) direct(true, 0) */ remote_oss infile 'oss://aa*bb/test.*.csv?host=xxx&access_id=xxx&access_key=xxx' replace into table t1 fields terminated by '|';` 会返回 `OB_NOT_SUPPORTED`。

  - 文件名通配符只支持 `*` 和 `?`。其他通配符虽然允许输入，但无法匹配任何结果。

## 示例

  <main id="notice" type='explain'>
     <h4>说明</h4>
     <p>下面的示例是从服务器端文件导入数据的方法。OceanBase 数据库 <code>LOAD DATA</code> 语句旁路导入数据还支持加载本地文件（<code>LOCAL INFILE</code>）的方式。更多有关 <code>LOAD DATA LOCAL INFILE</code> 的示例信息，请参见 <a href="../700.migrate-data-from-csv-file-to-oceanbase-database/200.use-the-load-command-to-load-the-csv-data-file-to-the-oceanbase-database.md">使用 <code>LOAD DATA</code> 语句导入数据</a></p>
   </main>

1. 登录到要连接 OBServer 节点所在的机器，在 `/home/admin` 目录下创建测试数据。

    <main id="notice" type='explain'>
    <h4>说明</h4>
    <p>OceanBase 数据库中的 <code>LOAD DATA</code> 语句仅支持加载 OBServer 节点本地的输入文件。因此，需要在导入之前将文件拷贝到某台 OBServer 上。</p>
    </main>

    ```shell
    [xxx@xxx /home/admin]# ssh admin@10.10.10.1

    [admin@xxx /home/admin]# vi tbl1.csv
    1,11
    2,22
    3,33
    ```

2. 设置导入的文件路径。

    设置系统变量 `secure_file_priv`，配置导入或导出文件时可以访问的路径。

    <main id="notice" type='notice'>
      <h4>注意</h4>
      <p>由于安全原因，设置系统变量 <code>secure_file_priv</code> 时，只能通过本地 Socket 连接数据库执行修改该全局变量的 SQL 语句。更多信息，请参见 <a href="../../700.reference/800.configuration-items-and-system-variables/200.system-variable/300.global-system-variable/11500.secure_file_priv-global.md">secure_file_priv</a>。</p>
    </main>

    1. 登录到要连接 OBServer 节点所在的机器。

        ```shell
        [xxx@xxx /home/admin]# ssh admin@10.10.10.1
        ```

    2. 执行以下命令，通过本地 Unix Socket 连接方式连接租户 `mysql001`。

        ```shell
        obclient -S /home/admin/oceanbase/run/sql.sock -uroot@mysql001 -p******
        ```

    3. 设置导入路径为 `/home/admin`。

        ```shell
        obclient [(none)]> SET GLOBAL secure_file_priv = "/home/admin";
        Query OK, 0 rows affected
        ```

3. 重新连接数据库后，使用 `LOAD /*+ APPEND */ DATA` 语句导入数据。

    ```shell
    obclient [test]> CREATE TABLE tbl1(col1 INT PRIMARY KEY,col2 INT);
    Query OK, 0 rows affected

    obclient [test]> SELECT * FROM tbl1;
    Empty set

    obclient [test]> LOAD DATA /*+ direct(true,1024) parallel(16) */ INFILE '/home/admin/tbl1.csv' INTO TABLE tbl1 FIELDS TERMINATED BY ',';
    Query OK, 3 rows affected
    Records: 3  Deleted: 0  Skipped: 0  Warnings: 0

    obclient [test]> SELECT * FROM tbl1;
    +------+------+
    | col1 | col2 |
    +------+------+
    |    1 |   11 |
    |    2 |   22 |
    |    3 |   33 |
    +------+------+
    3 rows in set
    ```

## 相关文档

* 更多有关使用 `LOAD DATA` 语句的示例信息，请参见 [使用 LOAD DATA 语句导入数据](../700.migrate-data-from-csv-file-to-oceanbase-database/200.use-the-load-command-to-load-the-csv-data-file-to-the-oceanbase-database.md)。

* 更多有关连接数据库的详细信息，请参见 [连接方式概述](../../300.develop/100.application-development-of-mysql-mode/100.connect-to-oceanbase-database-of-mysql-mode/100.connection-methods-overview-of-mysql-mode.md)。

* 更多有关删除表的信息，请参见 [删除表](../../700.reference/300.database-object-management/200.manage-object-of-oracle-mode/100.manage-tables-of-oracle-mode/800.delete-a-table-of-oracle-mode.md)。
