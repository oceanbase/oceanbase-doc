| Description   |                 |
|---------------|-----------------|
| keywords      |                 |
| dir-name      |                 |
| dir-name-en   |                 |
| tenant-type   | Oracle Mode     |

# ORA_ROWSCN 伪列

OceanBase 数据库存储数据时使用多版本存储。在一张表中，`ORA_ROWSCN` 可以被视为表中的一列，该列值代表每一行数据的最新版本号。对于两个事务 `t1` 和 `t2`，假设 `t1` 先提交，然后 `t2` 提交，OceanBase 保证查询 `t1` 发生后的 `ORA_ROWSCN` 小于 `t2` 发生后的 `ORA_ROWSCN`。在 OceanBase 数据库中，`ORA_ROWSCN` 是单调递增的。不同于 Oracle 数据库，Oracle 数据库的 `ORA_ROWSCN` 是系统内的一个逻辑数字，没有实际意义。而在 OceanBase 数据库中，`ORA_ROWSCN` 是数据修改所在事务提交时的系统时间，可以转换成有意义的时间。

## 注意事项

* 只能在实体表中使用 `ORA_ROWSCN`，不能在对视图的查询中使用 `ORA_ROWSCN` 伪列。
* `ORA_ROWSCN` 可以当成普通列一样出现在 `WHERE` 等表达式部分。
* 因为 `ORA_ROWSCN` 是非保留关键字，所以如果有列定义名字为 `ORA_ROWSCN`，那么 `ORA_ROWSCN` 伪列将不会起作用。
* 无法将 `ORA_ROWSCN` 与 `FLASHBACK QUERY` 语句一起使用，否则 `ORA_ROWSCN` 的语义将产生歧义。

## 示例

1. 创建测试表 `tbl1`。

    ```sql
    CREATE TABLE tbl1(col1 INT);
    ```

2. 向表 `tbl1` 中插入一条测试数据。

    ```sql
    INSERT INTO tbl1 VALUES(10);
    ```

3. 再次向表 `tbl1` 中插入三条测试数据。

    ```sql
    INSERT INTO tbl1 VALUES(30),(40),(50);
    ```

4. 获取表 `tbl1` 中 `col1 = 10` 的列对应的 `ORA_ROWSCN`。

    ```sql
    SELECT ORA_ROWSCN FROM tbl1 WHERE col1 = 10;
    ```

    返回结果如下：

    ```shell
    +---------------------+
    | ORA_ROWSCN          |
    +---------------------+
    | 1721975097797659000 |
    +---------------------+
    1 row in set
    ```

5. 获取 `ORA_ROWSCN` 为指定值的数据，如同一批事务提交数据 `ORA_ROWSCN` 都是相同的。

   1. 获取表 `tbl1` 中 `col1 = 30/40/50` 的列对应的 `ORA_ROWSCN`。

       ```sql
       SELECT col1, ORA_ROWSCN FROM tbl1 WHERE col1 IN (30,40,50);
       ```

       返回结果如下：

       ```shell
       +------+---------------------+
       | COL1 | ORA_ROWSCN          |
       +------+---------------------+
       |   30 | 1721975326593884000 |
       |   40 | 1721975326593884000 |
       |   50 | 1721975326593884000 |
       +------+---------------------+
       3 rows in set
       ```

   2. 更新表 `tbl1`，通过指定 `ORA_ROWSCN` 的值来定位需要更新的行，然后将 `col1` 的值更新为 `20`。

       ```sql
       UPDATE tbl1 SET col1 = 20 WHERE ORA_ROWSCN = 1721975326593884000;
       ```

       返回结果如下：

       ```sql
       Query OK, 3 rows affected
       Rows matched: 3  Changed: 3  Warnings: 0
       ```

6. `ORA_ROWSCN` 用在表达式中。

    ```sql
    SELECT col1, ORA_ROWSCN FROM tbl1 WHERE ORA_ROWSCN + 1 = 1721975097797659001;
    ```

    返回结果如下：

    ```shell
    +------+---------------------+
    | COL1 | ORA_ROWSCN          |
    +------+---------------------+
    |   10 | 1721975097797659000 |
    +------+---------------------+
    1 row in set
    ```
