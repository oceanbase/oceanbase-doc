# 配置用户级资源隔离

用户级资源隔离是通过将某个用户执行的 SQL 绑定到指定资源组上执行来实现的。本文主要介绍了 Oracle 模式下用户级资源隔离的配置方法。

## 前提条件

* 开始配置用户级资源隔离前，请确认您已经配置 cgroups，配置 cgroups 的详细操作请参见 [配置 cgroups](../200.resource-isolation-for-oracle-mode/100.config-cgroups-for-oracle-mode.md)。

* 开始配置用户级资源隔离前，建议您先了解资源组、资源管理计划、资源管理计划内容等基础概念，用户级资源隔离相关的基础概念及适用场景请参见 [资源隔离概述](../100.resource-isolation-overview.md)。

* 请确认已创建好需要进行资源隔离的用户。创建用户的详细操作请参见 [创建用户](../../../200.basic-database-management/400.manage-tenants/500.manage-users-and-permissions/200.oracle-mode/100.create-user-of-oracle-mode.md)。

## 操作步骤

以下示例中，将 `tp_user` 用户和 `ap_user` 用户分别绑定在 `big_group` 和 `small_group` 2 个资源组上，再通过资源管理计划 `plan_a` 来控制不同用户使用不同的 CPU 资源。

1. 租户管理员登录到集群的 Oracle 租户。

2. 调用 `DBMS_RESOURCE_MANAGER` 系统包中的 `CREATE_CONSUMER_GROUP` 子程序创建资源隔离所需的 2 个资源组。

   ```sql
   obclient [SYS]> delimiter //

   obclient [SYS]> BEGIN DBMS_RESOURCE_MANAGER.CREATE_CONSUMER_GROUP(
   consumer_group => 'big_group' ,
   COMMENT => 'TP'
   );
   END; //

   obclient [SYS]> BEGIN DBMS_RESOURCE_MANAGER.CREATE_CONSUMER_GROUP(
   consumer_group => 'small_group' ,
   COMMENT => 'AP'
   );
   END; //
   ```

   相关参数说明如下：

   * `CONSUMER_GROUP` ：定义资源组名称。

   * `COMMENT` ：填写资源组的备注信息。

   创建成功后，可以查询 `DBA_RSRC_CONSUMER_GROUPS` 视图进行确认。`DBA_RSRC_CONSUMER_GROUPS` 视图的详细介绍请参见 [DBA_RSRC_CONSUMER_GROUPS](../../../../500.system-reference/500.system-view-of-oracle-mode/200.dictionary-view-of-oracle-mode/12200.dba_rsrc_consumer_groups-of-oracle-mode.md)。

3. 调用 `DBMS_RESOURCE_MANAGER` 系统包中的 `CREATE_PLAN` 子程序创建资源管理计划。

   ```sql
   obclient [SYS]> BEGIN DBMS_RESOURCE_MANAGER.CREATE_PLAN(
   PLAN => 'plan_a');
   END; //
   ```

   相关参数说明如下：

   * `PLAN` ：定义资源管理计划名称。
  
   * `COMMENT` ：填写资源管理计划的备注信息。

   创建成功后，可以查询 `DBA_RSRC_PLANS` 视图进行确认。`DBA_RSRC_PLANS` 视图的详细介绍请参见 [DBA_RSRC_PLANS](../../../../500.system-reference/500.system-view-of-oracle-mode/200.dictionary-view-of-oracle-mode/12400.dba_rsrc_plans-of-oracle-mode.md)。

4. 调用 `DBMS_RESOURCE_MANAGER` 系统包中的 `CREATE_PLAN_DIRECTIVE` 子程序创建资源管理计划对应的资源管理计划内容。

   ```sql
   obclient [SYS]> BEGIN DBMS_RESOURCE_MANAGER.CREATE_PLAN_DIRECTIVE(
   PLAN => 'plan_a',
   GROUP_OR_SUBPLAN => 'big_group' ,
   MGMT_P1 => 60,
   UTILIZATION_LIMIT => 70);
   END; //

   obclient [SYS]> BEGIN DBMS_RESOURCE_MANAGER.CREATE_PLAN_DIRECTIVE(
   PLAN => 'plan_a',
   GROUP_OR_SUBPLAN => 'small_group' ,
   MGMT_P1 => 40,
   UTILIZATION_LIMIT => 80);
   END; //
   ```

   相关参数说明如下：

   * `PLAN`：指定该资源管理计划内容所关联的资源管理计划名。

   * `GROUP_OR_SUBPLAN`：指定资源组。

   * `MGMT_P1`：指定系统满负载情况下，承诺分配给本资源组的 CPU 占比。

   * `UTILIZATION_LIMIT`：指定资源组使用的 CPU 资源的上限。 该参数的取值范围为 (0, 100\]。`100` 表示最大可使用租户全部 CPU 资源。如果取值为 `70` 则表示最大可使用租户 70% 的 CPU 资源。

   创建成功，可以查询 `DBA_RSRC_PLAN_DIRECTIVES` 视图进行确认。`DBA_RSRC_PLAN_DIRECTIVES`视图的详细介绍请参见 [DBA_RSRC_PLAN_DIRECTIVES](../../../../500.system-reference/500.system-view-of-oracle-mode/200.dictionary-view-of-oracle-mode/12500.dba_rsrc_plan_directives-of-oracle-mode.md)。

5. 调用 `DBMS_RESOURCE_MANAGER` 系统包中的 `SET_CONSUMER_GROUP_MAPPING` 子程序添加用户级资源隔离匹配规则。

   ```sql
   obclient [SYS]> BEGIN DBMS_RESOURCE_MANAGER.SET_CONSUMER_GROUP_MAPPING(
   ATTRIBUTE => 'user',
   VALUE => 'tp_user',
   CONSUMER_GROUP => 'big_group');
   END; //

   obclient [SYS]> BEGIN DBMS_RESOURCE_MANAGER.SET_CONSUMER_GROUP_MAPPING(
   ATTRIBUTE => 'user',
   VALUE => 'ap_user',
   CONSUMER_GROUP => 'small_group');
   END; //

   obclient [SYS]>delimiter ;
   ```

   相关参数说明如下：

   * `ATTRIBUTE` ：指定属性类型，`column` 表示 SQL 级资源隔离，`user` 表示用户级资源隔离，属性名称不区分大小写。

   * `VALUE` ：指定属性值，指定用户名即可。当前仅支持指定一个用户。

     在 OceanBase 数据库的 Oracle 模式中，语句执行成功后，用户名均会自动调整为大写，如果需要保持为小写，您可以通过添加双引号的方式避免其变成大写。示例如下：

     ```sql
     obclient [SYS]> DBMS_RESOURCE_MANAGER.SET_CONSUMER_GROUP_MAPPING(
     ATTRIBUTE       =>  'user',
     VALUE            => '"user1"'
     CONSUMER_GROUP   => 'big_group');
     ```

   * `CONSUMER_GROUP`：指定需要绑定的资源组。表示当 SQL 命中 `VALUE` 中所设置的匹配规则后，需要绑定在哪个资源组上执行该语句。当前仅支持绑定一个资源组。

   创建成功后，可以查询 `DBA_RSRC_GROUP_MAPPINGS` 视图进行确认。`DBA_RSRC_GROUP_MAPPINGS` 视图的详细介绍请参见 [DBA_RSRC_GROUP_MAPPINGS](../../../../500.system-reference/500.system-view-of-oracle-mode/200.dictionary-view-of-oracle-mode/12300.dba_rsrc_group_mappings-of-oracle-mode.md)。

6. 为资源组启用合适的资源管理计划。

   由于不同的资源管理计划中，同一个资源组被限制的资源可能不同。您需要为资源组启用合适的资源管理计划。

   ```sql
   obclient [SYS]> ALTER SYSTEM SET resource_manager_plan = 'plan_a';
   ```

## 配置后的注意事项

* 资源隔离匹配规则添加后，如果删除了用户后再重建，则资源隔离匹配规则仍然适用。

* 资源隔离匹配规则添加成功后不是立即生效，预计可能在十秒内开始生效，具体以实际环境为准。

* 用户级资源隔离的优先级低于 SQL 级资源隔离。

* 资源隔离匹配规则添加后，目前仅在 `SELECT`、`INSERT`、`UPDATE`、`DELETE` 等语句中生效，在 DDL 和 DCL 语句中不生效，在 PL 中也不生效。在 prepareStatement 中可以生效。

## 配置后的性能影响

用户级资源隔离在 SQL 解析前即可确认使用哪个资源组的资源，故对性能无影响。

## 相关文档

[SQL 级资源隔离](../200.resource-isolation-for-oracle-mode/300.resource-isolation-at-sql-level-for-oracle-mode.md)
