|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# oceanbase.DBA_OB_DEADLOCK_EVENT_HISTORY

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>从 V4.0.0 版本开始引入。</p>
</main>

## 功能描述

视图 `DBA_OB_DEADLOCK_EVENT_HISTORY` 展示死锁事件的历史记录，该视图在非 root 租户下展示本租户的历史记录。

## 字段说明

| 字段名称 | 类型 | 是否可以为 NULL | 描述 |
| ------- | ------ | ------ | ------ |
| EVENT_ID       | bigint(20) unsigned | NO   | 死锁事件的编号     |
| SVR_IP         | varchar(46)         | NO   | 参与该死锁事件的节点的 IP 地址     |
| SVR_PORT       | bigint(20) unsigned | NO   | 参与该死锁事件的节点的端口号     |
| DETECTOR_ID    | bigint(20) unsigned | NO   | 参与该死锁事件的节点 ID 标识（进程内唯一）     |
| REPORT_TIME    | timestamp(6)        | NO   | 该死锁事件的上报时间（以汇报服务器的时间戳为准）     |
| CYCLE_IDX      | bigint(20)          | NO   | 该节点在环中的编号     |
| CYCLE_SIZE     | bigint(20)          | NO   | 参与该死锁事件的节点的数量     |
| ROLE           | longtext            | NO   | 该节点在该死锁事件中的角色：<li>witness<li>victim     |
| PRIORITY_LEVEL | longtext            | NO   | 该节点的优先级的等级描述：<li>extreme-low<li>low<li>normal<li>high<li>extreme-high     |
| PRIORITY       | bigint(20) unsigned | NO   | 该节点所具有的优先级的值。当优先级相同时，优先级的值才具有可比性，环中优先级值最低的节点被淘汰     |
| CREATE_TIME    | timestamp(6)        | NO   | 该节点创建的时间     |
| START_DELAY_US | bigint(20) unsigned | NO   | 该节点自创建后至允许其开始探测死锁的间隔时间，单位为微秒     |
| MODULE         | longtext            | NO   | 该节点所在的模块，取值固定为 transaction     |
| VISITOR        | longtext            | NO   | 该节点所代表的资源访问者，格式为 `{session_id:$1}:{txid:$2}`，`$1` 与 `$2` 均为数字<main id="notice" type='explain'><h4>说明</h4><p>该字段在 V4.2.5 之前版本格式为 <code>{txid:xx}</code>。</p></main>     |
| OBJECT         | longtext            | NO   | 该节点想要获取的资源，行的主键内容说明，格式为 `{addr:“$1:$2”}:{ls:$3}:{tablet:$4}:{row_key:{$5}}`，其中<ul><li><code>\$1</code> 为 IP。 </li><li><code>\$2</code> 为 PORT。与 <code>\$1</code> 共同组成冲突发生的机器进程地址。 </li><li><code>\$3</code> 为冲突发生时所在的日志流。 </li><li><code>\$4</code> 为冲突发生时所在的 Tablet。 </li><li><code>\$5</code> 为行锁主键字符串化后的内容。 </li></ul> <main id="notice" type='explain'><h4>说明</h4><p>该字段在 V4.2.5 之前版本格式为 <code>{row_key:xxx}</code>。</p></main>    |
| EXTRA_NAME1    | longtext            | YES  | 由上层希望添加到死锁汇报事件中的额外信息名称 1，格式为 `wait_sql`<main id="notice" type='explain'><h4>说明</h4><p>该字段在 V4.2.5 之前版本格式为 <code>current sql</code>。</p></main>     |
| EXTRA_VALUE1   | longtext            | YES  | 事务发生死锁的当前正在执行的 SQL 内容     |
| EXTRA_NAME2    | longtext            | YES  | 由上层希望添加到死锁汇报事件中的额外信息名称 2，格式为 `hold_sql_request_time`<main id="notice" type='explain'><h4>说明</h4><p>该字段在 V4.2.5 之前版本显示为空。</p></main>     |
| EXTRA_VALUE2   | longtext            | YES  | 持锁语句的请求时间<main id="notice" type='explain'><h4>说明</h4><p>该字段在 V4.2.5 之前版本显示为空。</p></main>     |
| EXTRA_NAME3    | longtext            | YES  | 由上层希望添加到死锁汇报事件中的额外信息名称 3，格式为 `hold_sql`<main id="notice" type='explain'><h4>说明</h4><p>该字段在 V4.2.5 之前版本显示为空。</p></main>     |
| EXTRA_VALUE3   | longtext            | YES  | 持有 `cycle_idx - 1` 行记录对应的 Object 的 SQL 语句<main id="notice" type='explain'><h4>说明</h4><p>该字段在 V4.2.5 之前版本显示为空。</p></main>     |

## 查询示例

查询所有租户死锁事件的历史记录。

```shell
obclient [oceanbase]> SELECT * FROM oceanbase.DBA_OB_DEADLOCK_EVENT_HISTORY LIMIT 10;
```
