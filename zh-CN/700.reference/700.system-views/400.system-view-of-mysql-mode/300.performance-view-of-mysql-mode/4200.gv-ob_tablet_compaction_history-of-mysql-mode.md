|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type|MySQL Mode|

# GV$OB_TABLET_COMPACTION_HISTORY

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>从 V4.0.0 版本开始引入。</p>
</main>

## 功能描述

视图 `GV$OB_TABLET_COMPACTION_HISTORY` 用于展示 Tablet 级 Compaction 的历史信息。

## 字段说明

|  字段名称     |   类型      | 是否可以为 NULL |  描述   |
|--------------|--------------|----------------|--------|
|SVR_IP            |varchar(46)   |NO   |服务器IP    |
|SVR_PORT          |bigint(20)    |NO   |服务器端口号    |
|TENANT_ID         |bigint(20)    |NO   |租户ID    |
|LS_ID             |bigint(20)    |NO   |日志流ID    |
|TABLET_ID         |bigint(20)    |NO   |数据分片ID    |
|TYPE              |varchar(64)   |NO   | Compaction 的类型：<ul><li>`MDS_TABLE_MERGE`：将系统的元数据按照 SSTable 的格式持久化到磁盘里。</li> <li>`MAJOR_MERGE`：租户级合并</li> <li>`MEDIUM_MERGE`：分区级合并</li> <li>`MINI_MERGE`：Mini Compaction，将 MemTable 转变成 Mini SSTable。</li> <li>`MINOR_MERGE`：Minor Compaction，多个 Mini SSTable 或多个 Mini SSTable 与 Minor SSTable 合成一个 Minor SSTable。</li> <li>`META_MAJOR_MERGE`：一种特殊的 Compaction 类型，是将某个指定时间点之前的数据合成一个 Meta Major SSTable，其数据格式与 Major SSTable 一样，不包含多版本数据和未提交事务数据。</li></ul>   |
|COMPACTION_SCN    |bigint(20) unsigned    |NO   |合并版本信息    |
|START_TIME        |timestamp(6)  |NO   |开始时间    |
|FINISH_TIME       |timestamp(6)  |NO   |结束时间    |
|TASK_ID           |varchar(64)   |NO   |任务执行Trace    |
|OCCUPY_SIZE       |bigint(20)    |NO   |数据量    |
|MACRO_BLOCK_COUNT                |bigint(20)    |NO   |宏块数    |
|MULTIPLEXED_MACRO_BLOCK_COUNT    |bigint(20)    |NO   |重用宏块数    |
|NEW_MICRO_COUNT_IN_NEW_MACRO     |bigint(20)    |NO   |新生成宏块中的新微块数    |
|MULTIPLEXED_MICRO_COUNT_IN_NEW_MACRO    |bigint(20)   |NO   |新生成宏块中的重用微块数    |
|TOTAL_ROW_COUNT                  |bigint(20)    |NO   |总行数    |
|INCREMENTAL_ROW_COUNT            |bigint(20)    |NO   |新输出的行    |
|COMPRESSION_RATIO                |double        |NO   |新数据的压缩率 = 新增宏块数据在压缩后/压缩前比率    |
|NEW_FLUSH_DATA_RATE              |bigint(20)    |NO   |新数据的输出速度，单位KB/s    |
|PROGRESSIVE_COMPACTION_ROUND     |bigint(20)    |NO   |渐近合并当前轮次（如果为全量合并，该列为-1）    |
|PROGRESSIVE_COMPACTION_NUM       |bigint(20)    |NO   |渐近合并总轮次    |
|PARALLEL_DEGREE                  |bigint(20)    |NO   |并行度    |
|PARALLEL_INFO                    |varchar(512)  |NO   |并行任务信息，会展示并行任务扫描的数据量/运行时间/输出的数据量的统计信息（min/max/avg）    |
|PARTICIPANT_TABLE                |varchar(512)  |NO   |参与本次compaction的table信息    |
|MACRO_ID_LIST                    |varchar(256)  |NO   |输出的宏块列表，宏块列表过长则不展示    |
|COMMENTS                         |varchar(1024) |NO   |备注信息，展示之前调度或执行过程中遇到的问题    |
| START_CG_ID                     | bigint(20)   | NO   |  Column Group 的 Start ID<main id="notice" type='explain'><h4>说明</h4><p>该字段从 V4.3.0 版本开始引入。</p></main>    |
| END_CG_ID                       | bigint(20)   | NO   |  Column Group 的 End ID <main id="notice" type='explain'><h4>说明</h4><p>该字段从 V4.3.0 版本开始引入。</p></main>   |
| KEPT_SNAPSHOT                   | varchar(128) | NO   |  展示本次 Compaction 选择的多版本位点保留信息<main id="notice" type='explain'><h4>说明</h4><p>该字段从 V4.3.0 版本开始引入。</p></main>    |
| MERGE_LEVEL                     | varchar(64)  | NO   |  展示本次执行时是否采用合并/微块重用<main id="notice" type='explain'><h4>说明</h4><p>该字段从 V4.3.0 版本开始引入。</p></main>    |
| EXEC_MODE                       | varchar(64)  | NO   | 展示该合并 Trace 的模式：<ul><li>`EXEC_MODE_LOCAL`：本地模式，输出宏块到本地磁盘</li> <li>`EXEC_MODE_VALIDATE`：共享模式，仅计算 Checksum，不输出宏块。当前版本暂不支持该模式。</li> <li>`EXEC_MODE_OUTPUT`：共享模式，输出宏块到共享存储。当前版本暂不支持该模式。</li></ul> <main id="notice" type='explain'><h4>说明</h4><p>该字段从 V4.3.3 版本开始引入。</p></main> |
| IS_FULL_MERGE                   | varchar(5)   | NO   | 是否为全量合并。<main id="notice" type='explain'><h4>说明</h4><p>该字段从 V4.3.3 版本开始引入。</p></main> |
| IO_COST_TIME_PERCENTAGE         | bigint(20)   | NO   | IO 时间占合并时间的比例。 <main id="notice" type='explain'><h4>说明</h4><p>该字段从 V4.3.3 版本开始引入。</p></main> |
| MERGE_REASON                    | varchar(32)  | NO   | 合并发起的原因，取值如下：<ul><li>`LOAD_DATA_SCENE`：导数场景</li> <li>`TOMBSTONE_SCENE`：墓碑场景</li> <li>`INEFFICIENT_QUERY`：慢查询场景</li> <li>`FREQUENT_WRITE`：频繁写场景</li> <li>`TENANT_MAJOR`：租户级合并</li> <li>`USER_REQUEST`：用户发起的合并</li> <li>`REBUILD_COLUMN_GROUP`：行转列场景</li></ul> <main id="notice" type='explain'><h4>说明</h4><p>该字段从 V4.3.3 版本开始引入。</p></main> |
| BASE_MAJOR_STATUS               | varchar(64)  | NO   | 合并前 Major SSTable 的类型：<ul><li>`COL_WITH_ALL`：定义时为行列混存表，基线数据为行列混存</li> <li>`COL_ONLY_ALL`：定义时为行列混存表，基线数据自适应优化只存行存</li> <li>`PURE_COL`：定义时为纯列存表，基线数据为纯列存</li> <li>`PURE_COL_ONLY_ALL`：定义时为纯列存表，基线数据自适应优化只存行存</li> <li>`ROW_STORE_MAJOR`：行存表</li></ul> <main id="notice" type='explain'><h4>说明</h4><p>该字段从 V4.3.3 版本开始引入。</p></main>|
| CO_MERGE_TYPE                   | varchar(64)  | NO   | 列存合并类型：<ul><li>`BUILD_COLUMN_STORE_MERGE`：合并为列存</li> <li>`BUILD_ROW_STORE_MERGE`：合并为行存</li> <li>`USE_RS_BUILD_SCHEMA_MATCH_MERGE`：合并为匹配 Schema 的存储类型</li></ul> <main id="notice" type='explain'><h4>说明</h4><p>该字段从 V4.3.3 版本开始引入。</p></main> |

## 查询示例

用户租户查看所有 OBServer 节点上 Tablet 级 Compaction 的历史信息。

```shell
obclient [oceanbase]> SELECT * FROM oceanbase.GV$OB_TABLET_COMPACTION_HISTORY LIMIT 1\G
```

查询结果如下：

```shell
*************************** 1. row ***************************
                              SVR_IP: 172.xx.xx.xx
                            SVR_PORT: 2882
                           TENANT_ID: 1002
                               LS_ID: 1
                           TABLET_ID: 60379
                                TYPE: MAJOR_MERGE
                      COMPACTION_SCN: 1722880804553022418
                          START_TIME: 2024-08-06 02:00:14.374896
                         FINISH_TIME: 2024-08-06 02:00:14.381909
                             TASK_ID: YB4XXXXXXXXX-000XXXXXXXXXXXXX-0-0
                         OCCUPY_SIZE: 0
                   MACRO_BLOCK_COUNT: 0
       MULTIPLEXED_MACRO_BLOCK_COUNT: 0
        NEW_MICRO_COUNT_IN_NEW_MACRO: 0
MULTIPLEXED_MICRO_COUNT_IN_NEW_MACRO: 0
                     TOTAL_ROW_COUNT: 0
               INCREMENTAL_ROW_COUNT: 0
                   COMPRESSION_RATIO: 1
                 NEW_FLUSH_DATA_RATE: 0
        PROGRESSIVE_COMPACTION_ROUND: 1
          PROGRESSIVE_COMPACTION_NUM: 0
                     PARALLEL_DEGREE: 1
                       PARALLEL_INFO: -
                   PARTICIPANT_TABLE: table_cnt=1,[MAJOR]snapshot_version=1;
                       MACRO_ID_LIST:
                            COMMENTS: comment="merge_reason="TENANT_MAJOR";time=add_time:1722880814374751|total=7.01ms;";
                         START_CG_ID: 0
                           END_CG_ID: 0
                       KEPT_SNAPSHOT: {type:"SNAPSHOT_UNDO_RETENTION", snapshot:1722879004021414960}
                         MERGE_LEVEL: MICRO_BLOCK_LEVEL
                           EXEC_MODE: EXEC_MODE_LOCAL
             IO_COST_TIME_PERCENTAGE: 5
                        MERGE_REASON:
                   BASE_MAJOR_STATUS:
                       CO_MERGE_TYPE:
1 row in set
```

## 相关视图或文档

* [V$OB_TABLET_COMPACTION_HISTORY](34800.v-ob_tablet_compaction_history-of-mysql-mode.md)

* [GV$OB_TABLET_COMPACTION_PROGRESS](4300.gv-ob_tablet_compaction_progress-of-mysql-mode.md)

* [查看转储信息](../../../200.system-management/500.manage-data-storage/100.dump-management/400.view-dump-information.md)

* [查看合并信息](../../../200.system-management/500.manage-data-storage/200.merge-management/500.view-merge-process.md)
