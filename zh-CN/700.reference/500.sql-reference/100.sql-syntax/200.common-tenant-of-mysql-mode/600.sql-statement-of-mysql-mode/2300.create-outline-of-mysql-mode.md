| Description   |                 |
|---------------|-----------------|
| keywords      |                 |
| dir-name      |                 |
| dir-name-en   |                 |
| tenant-type   | MySQL Mode      |

# CREATE OUTLINE

## 描述

该语句用来创建 Outline。可以通过两种方式创建，一种是通过 `SQL_TEXT`（用户执行的带参数的原始语句），另一种是通过 `SQL_ID` 创建。

  <main id="notice" type='explain'>
    <h4>说明</h4>
    <p>创建 Outline 需要进入对应的数据库下执行。</p>
  </main>

当 `SQL_ID` 相同时，使用 `SQL_TEXT` 方式创建的 Outline 会覆盖 `SQL_ID` 方式创建的 Outline，`SQL_TEXT` 方式创建的优先级更高。

此外，OceanBase 数据库通过 `SQL_ID` 区分不同的 SQL，而 `SQL_ID` 是通过 `SQL_TEXT` 取 MD5 加密得到的，相同的 SQL 文本即使多一个换行或制表符，MD5 得到的 `SQL_ID` 都会不同。在实际生产系统中，推荐通过 `SQL_ID` 进行 Outline 绑定。

## 权限要求

执行 `CREATE OUTLINE` 语句需要当前用户具备 `CREATE` 管理权限。有关 OceanBase 数据库权限的详细介绍，请参见 [MySQL 模式下的权限分类](../../../../../600.manage/500.security-and-permissions/300.access-control/200.user-and-permission/200.permission-of-mysql-mode/100.permission-classification-of-mysql.md)。

## 语法

* 使用 `SQL_TEXT` 创建 Outline。

  ```sql
  CREATE [OR REPLACE] OUTLINE outline_name ON stmt [ TO target_stmt ];
  ```

* 使用 `SQL_ID` 创建 Outline。

  ```sql
  CREATE OUTLINE outline_name ON sql_id USING HINT hint;
  ```

## 参数解释

|     **参数**     |                                                                                                                                **描述**                                                                                                                                |
|----------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| outline_name   | 指定要创建的 Outline 名称。                                                                                                                                                                                                                                                   |
| OR REPLACE     | 指定 `OR REPLACE` 后，如果要创建的 Outline 已存在，则会替换原有的 Outline。                                                                                                                                                                                                                |
| stmt           | 一般为一个带有 Hint 和原始参数的 DML 语句。                                                                                                                                                                                                                                          |
| TO target_stmt | 如果不指定 `TO target_stmt`，则表示如果数据库接受的 SQL 参数化后与 `stmt` 去掉 Hint 参数化文本相同，则将该 SQL 绑定 `stmt` 中 Hint 生成执行计划；如果期望对含有 Hint 的语句进行固定计划，则需要 `TO target_stmt` 来指明原始的 SQL。 <br>**注意**  在使用 `target_stmt` 时，严格要求 `stmt` 与  `target_stmt` 在去掉 Hint 后完全匹配。</br> |
| sql_id         | 如果 `sql_id` 对应的 SQL 语句已经有 Hint，则创建 Outline 指定的 Hint 会覆盖原始语句中所有 Hint。                                                                                                                                                                                                 |
| hint           | 格式为 `/*+ xxx */`。 <main id="notice" ><h4>说明</h4><p><ul><li>当使用 <code>SQL_TEXT</code> 创建 Outline 以实现查询限流时，不需要特意指定额外的参数。例如，可以这样创建一个 Outline：<code>create outline otl2 on select /*+ max_concurrent(1) */ * from t where c1=?</code>，这里的 <code>c1</code> 使用参数化的占位符（如 <code>?</code>）而不必指定具体的值。</li></ul><ul><li>当绑定执行计划时，必须指定相应的参数。例如，创建绑定执行计划的 Outline 可以使用类似的语句：<code>create outline otl2 on select /*+ norewrite */ * from t where c1=1</code>，这里的 <code>c1</code> 需要指定具体的值。 </li></ul></p></main>   |


## 示例

* 使用 `SQL_TEXT` 创建 Outline。

  ```sql
  obclient> CREATE OUTLINE otl_idx_c2
  ON SELECT/*+ index(t1 idx_c2)*/ * FROM t1 WHERE c2 = 1;
  ```

* 使用 `SQL_ID` 创建 Outline。

  ```sql
  obclient> CREATE OUTLINE otl_idx_c2
  ON "ED570339F2C856BA96008A29EDF04C74"
  USING HINT /*+ index(t1 idx_c2)*/ ;
  ```

* 使用 `SQL_TEXT` 创建 Outline，在 HINT 里同时指定限流和执行计划：

  ```sql
  obclient> CREATE OUTLINE otl_idx_c2 ON SELECT /*+ use_nl(tbl2) max_concurrent(1)*/ * FROM t WHERE c1=?;