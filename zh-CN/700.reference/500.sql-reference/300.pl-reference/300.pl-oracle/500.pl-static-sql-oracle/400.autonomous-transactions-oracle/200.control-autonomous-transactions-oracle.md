| Description   |                 |
|---------------|-----------------|
| keywords      |                 |
| dir-name      |                 |
| dir-name-en   |                 |
| tenant-type   | Oracle Mode     |

# 控制自治事务

自治例程从第一个SQL 语句开始事务。当一个事务结束时，下一个 SQL 语句开始另一个事务。

  <main id="notice" >
    <h4>功能适用性</h4>
    <p>该内容仅适用于 OceanBase 数据库企业版。OceanBase 数据库社区版仅提供 MySQL 模式。</p>
  </main>

自上次提交或回滚之后的所有运行的 SQL 语句均构成当前事务。要控制自治事务，请使用以下语句，这些语句仅适用于当前（活动）事务：

* `COMMIT`

  

* `ROLLBACK [TO savepoint_name]`

  

* `SAVEPOINT savepoint_name`

  




进入和退出自治例程 
------------------------------

当进入自治例程的可执行部分时，主事务将挂起。退出例程后，主事务将恢复。

如果尝试退出活动的自治事务而不执行提交或回滚，则数据库将引发异常。如果未处理该异常，或者由于其他一些未处理的异常而导致事务结束，则该事务将回滚。

要正常退出例程，必须显式提交或回滚所有自治事务。如果例程（或由例程调用的任何例程）具有待处理事务，则 PL 会引发异常，并且待处理事务会回滚。

提交和回滚自治事务 
------------------------------

`COMMIT` 和 `ROLLBACK` 可以结束活动的自治事务，但不退出自主例程。当一个事务结束时，下一个 SQL 语句开始另一个事务。如果一个自治例程发出多个 `COMMIT` 语句，则可以包含多个自治事务。

Savepoint 
------------------------

Savepoint 只对定义它的事务有效。主事务中定义的 Savepoint 与其自治事务中定义的 Savepoint 无关。实际上，主事务和自治事务可以使用相同的 Savepoint 名称。

您只能回滚到当前事务中标记的 Savepoint。在自治事务中，无法回滚到主事务中标记的 Savepoint。为此，必须通过退出自治例程来恢复主事务。

在主事务中时，回滚到在启动自治事务之前标记的 Savepoint 不会回滚该自治事务。请记住，自治事务完全独立于主事务。

避免自主事务中的错误 
-------------------------------

为避免一些常见错误，请记住如下事项：

* 如果自治事务试图访问主事务所拥有的资源，则会发生死锁。数据库在自治事务中引发异常，如果未处理该异常，则回滚。

  

* 如果尝试退出活动的自治事务而不提交或回滚，则数据库将引发异常。如果未处理异常，则事务回滚。

  

* 打开自治事务时，不能在自治例程中运行 `PIPE ROW` 语句。在运行 `PIPE ROW` 语句之前必须关闭自治事务。这通常是通过在运行 `PIPE ROW` 语句之前提交或回滚自治事务来实现的。

  



