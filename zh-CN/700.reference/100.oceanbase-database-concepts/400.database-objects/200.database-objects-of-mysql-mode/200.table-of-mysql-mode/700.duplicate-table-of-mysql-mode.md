|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type|MySQL Mode|

# 复制表

复制表是 OceanBase 数据库中的一种特殊表。这种表可以在任意一个“健康”的副本上读取到数据的最新修改。对于写入频率较低、对读操作延迟和负载均衡要求较高的用户来说，复制表是一种理想的选择。

## 什么是复制表

复制表与普通表的主要区别体现在读副本是否可以支持读最新数据。普通表的副本只可以执行弱一致性读请求，读旧版本数据；复制表的副本可以支持强一致性读，读最新版本数据。

当用户创建一个复制表时，当前租户的所有 OBServer 节点上都会创建一个复制表的副本。其中，一个副本会被选为 Leader，负责接受写请求，而其余副本只能接受读请求。

所有副本需要向 Leader 汇报状态，主要是副本的回放进度，即数据同步的进度。通常情况下，Follower 的回放进度会略落后于 Leader，只要落后的幅度没有超过固定的阈值，Leader 就会认为副本处于“健康”状态，能够快速回放 Leader 上的修改。当 Leader 认为某个副本在一定时间内保持“健康”后，会授予 Follower 一段时间的 Lease。简单来说，Leader 在接下来的时间里“信任” Follower 会保持“健康”状态，并能够提供强一致性读服务。在此“信任”期内，Leader 会在每次提交复制表事务前确认 Follower 的回放进度。只有当 Follower 回放出本事务的修改后，Leader 才会向用户报告事务提交成功。在此情况下，用户可以在“健康”的 Follower 上读取到刚刚提交的事务的修改，前提是该 Follower 的回放进度已追赶到事务提交时的状态。

## 为什么需要复制表

“一写多读”是数据库中较为常见的一种部署方式，即一个节点处理所有写操作，然后将逻辑日志异步同步到其他读节点，如 Amazon Aurora。这种部署方式的好处在于可以将读压力分散到多个节点，提高容灾能力，并且与客户端物理距离较近的节点的读延迟会更低。

在 OceanBase 中，通常采用弱一致性读加多副本的方式来实现这种需求，其中一个副本（Leader）提供写服务和即时的强一致性读，而其他 Follower 则可以读取到较旧的已提交数据。弱一致性读是在异步复制的数据同步方式下的一种常见选择，Leader 在写入时不需要关注 Follower 的数据回放进度，Follower 则可以提供一致的旧版本数据读取。

然而，在某些场景下，用户的写入频率很低，对写入操作的延迟并不敏感。相对而言，这些用户更加关注读操作的延迟和负载均衡，并希望能及时读取到最新数据。复制表功能就是为了满足这种需求而设计的，在牺牲少量事务提交性能的前提下，复制表可以在任何一个“健康”的 Follower 上读取到最新数据。这里所提到的“健康”是指 Follower 与 Leader 之间的网络通畅、回放进度差距不大。

## 复制表在 V3.x 版本与 V4.x 版本的差异

复制表功能在 OceanBase 数据库 V3.x 版本上已经存在，而在 V4.x 版本中，由于 OceanBase 数据库的架构发生了较大变化，V4.x 版本的复制表适应了单机日志流的新架构，引入了基于分区的可读版本号校验以及基于日志流的 Lease 授予机制，以保证强一致性读的正确性。

此外，V4.x 版本的复制表功能完善了切主时不终止事务的能力。在用户或负载均衡发起 Leader 切换时，未提交的复制表事务不会像 V3.x 版本那样无法继续，而是可以在切主后继续执行。与 V3.x 版本相比，V4.x 的复制表功能在写事务性能和容灾能力方面都有所提升，副本宕机对读操作的影响更低。

## 如何使用复制表

创建复制表的语法是在 `CREATE TABLE` 语句后添加 `DUPLICATE_SCOPE` 选项。仅用户租户可以创建复制表，`sys` 租户无法创建复制表。创建复制表的 SQL 语句如下：

```sql
CREATE TABLE table_name column_definition DUPLICATE_SCOPE='none | cluster';
```

其中，`DUPLICATE_SCOPE` 参数用来指定复制表的属性，取值如下：

* `none`：默认值，表示该表是一个普通表。
* `cluster`：表示该表是一个复制表，Leader 需要将事务复制到当前租户的所有 F 副本及 R 副本。

当某个租户的第一个复制表被创建时，系统会同时创建一个特殊的日志流——广播日志流。之后新创建的复制表都会使用广播日志流。广播日志流与普通日志流的不同之处在于，广播日志流会自动在租户内的每个 OBServer 节点上部署一个副本，确保在理想情况下，复制表可以在任何一个 OBServer 节点上提供强一致性读。您可以通过以下 SQL 查询租户的复制表所在的广播日志流：

```sql
SELECT * FROM SYS.DBA_OB_LS WHERE flag LIKE "%DUPLICATE%";
```

查询结果示例如下：

```shell
+-------+--------+--------------+---------------+-------------+---------------------+----------+---------------------+---------------------+-----------+
| LS_ID | STATUS | PRIMARY_ZONE | UNIT_GROUP_ID | LS_GROUP_ID | CREATE_SCN          | DROP_SCN | SYNC_SCN            | READABLE_SCN        | FLAG      |
+-------+--------+--------------+---------------+-------------+---------------------+----------+---------------------+---------------------+-----------+
|  1003 | NORMAL | z1;z2        |             0 |           0 | 1684982852976428261 |     NULL | 1684983282912048623 | 1684983282912048623 | DUPLICATE |
+-------+--------+--------------+---------------+-------------+---------------------+----------+---------------------+---------------------+-----------+
1 rows in set
```

示例中，`LS_ID` 为 `1003` 的日志流即为广播日志流，当前租户的所有复制表都创建在该日志流上。有关广播日志流的更多介绍，请参见 [副本介绍](../../../../../600.manage/300.replica-management/100.replica-introduction.md)。

复制表创建成功后，可以像普通表一样进行插入和读写操作。不同的是，对于读请求，如果使用 Proxy 的方式连接数据库，则读请求可能会路由到任意一个 OBServer 节点执行；如果通过直连方式连接数据库，则只要本地副本可读，系统会在直连的 OBServer 节点上执行读请求。

## 相关文档

更多数据库连接方式的介绍，参见 [连接方式概述](../../../../../300.develop/100.application-development-of-mysql-mode/100.connect-to-oceanbase-database-of-mysql-mode/100.connection-methods-overview-of-mysql-mode.md)。

更多关于创建表的信息，参见[创建表](../../../../300.database-object-management/100.manage-object-of-mysql-mode/200.manage-tables-of-mysql-mode/200.create-a-table-for-mysql-tenant-of-mysql-mode.md)。
