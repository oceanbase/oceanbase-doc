|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# 恢复架构

本节主要介绍物理恢复流程及架构。

## 恢复概述

OceanBase 的物理恢复功能架构如下：

1. 选择租户级恢复或表级恢复

* 租户级别恢复：租户级恢复是基于已有数据的备份重建新租户的过程。租户级的整个恢复过程包括租户系统表和用户表的 Restore 和 Recover 过程。Restore 是将恢复需要的基线数据恢复到目标租户的 OBServer 节点，Recover 是将基线对应的日志恢复到对应的 OBServer 节点。租户恢复保证了跨表、跨分区的全局一致性。

* 表级别恢复：表级恢复是从备份数据中将用户指定的表恢复到一个已存在的租户，并且该已存在的租户与原表所在的租户可以是同一个租户，也可以是同一集群中的不同租户，还可以是不同集群中的租户。

2. 如果您选择租户级恢复，则又包含两种类型

<main id="notice" type='notice'>
  <h4>注意</h4>
  <p>快速恢复不支持数据备份，也不支持 FAIL/SWITCH OVER 成主库，只能作为备库存在。</p>
</main>

* 全量恢复：指恢复宏块数据和增量日志，当所有数据都从备份介质恢复到本地后，完成恢复的租户才可以提供服务。

* 快速恢复：指不恢复宏块数据就可以给用户提供服务，可以减少恢复等待时间并降低用户使用成本。

3. 为租户级别恢复的全量恢复/快速恢复选择恢复时间点

* 完全恢复：不指定恢复的时间戳。

* 指定 SCN 或者时间戳的不完全恢复：其中，SCN 是 OceanBase 数据库内部精确的版本号。时间戳在 Oracle 模式下精确到纳秒，没有精度丢失；时间戳在 MySQL 模式下精确到微秒，会丢失微秒之后的精度。

OceanBase 数据库的恢复流程的原理如下：

1. RS 根据备份的数据创建需要的日志流。

2. 日志流的 Leader 调度自己恢复数据和日志，Follower 从 Leader 拉取数据和日志。

3. RS 检测到所有的日志流恢复完成以后，认为租户数据恢复完成。

对于单个分区来说，备份 + 恢复的流程与服务器重启的流程比较类似，主要就是加载数据和应用日志。

## 恢复事务的一致性

OceanBase 数据库的物理备份恢复强依赖租户的 GTS 功能，GTS 保证了备份和恢复的数据是全局一致的。
