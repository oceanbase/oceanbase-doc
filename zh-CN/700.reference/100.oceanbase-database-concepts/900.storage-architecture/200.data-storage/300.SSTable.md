# SSTable

在 OceanBase 数据库中, 对于用户表每个分区管理数据的基本单元就是 SSTable，当 MemTable 的大小达到某个阈值后，OceanBase 数据库会将 MemTable 冻结，然后将其中的数据转存于磁盘上，转储后的结构就称之为 Mini SSTable 或者是 Minor SSTable。当集群发生全局合并时，每个用户表分区所有的 Minor SSTable 会根据合并快照点一起参与做 Major Compaction，最后会生成 Major SSTable。每个 SSTable 的构造方式类似，都是由自身的元数据信息和一系列的数据宏块组成，每个数据宏块内部则可以继续划分为多个微块，根据用户表模式定义的不同，微块可以选择使用平铺模式或者编码格式进行数据行的组织。

![SSTable](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/8073623461/p354863.jpg)

* **宏块**

  OceanBase 数据库将磁盘切分为大小为 2MB 的定长数据块，称之为宏块（Macro Block），宏块是数据文件写 IO 的基本单位，每个 SSTable 就由若干个宏块构成, 宏块2M固定大小的长度不可更改, 后续转储合并重用宏块以及复制迁移等任务都会以宏块为最基本粒度。
  
* **微块**

  在宏块内部数据被组织为多个大小为 16KB 左右的变长数据块，称之为微块（Micro Block），微块中包含若干数据行（Row），微块是数据文件读 IO 的最小单位。每个数据微块在构建时都会根据用户指定的压缩算法进行压缩，因此宏块上存储的实际是压缩后的数据微块，当数据微块从磁盘读取时，会在后台进行解压并将解压后的数据放入数据块缓存中。每个数据微块的大小在用户创建表时可以指定，默认 16KB，用户可以通过语句指定微块长度，但是不能超过宏块大小，语句如下。

  ```sql
  ALTER TABLE mytest SET block_size = 131072;
  ```

  一般来说微块长度越大，数据的压缩比会越高，但相应的一次 IO 读的代价也会越大；微块长度越小，数据的压缩比会相应降低，但相应的一次随机 IO 读的代价会更小。另外根据用户表模式的不同，每个微块构建的时候可能以平铺模式（Flat）或编码模式（Encoding）分别进行构建。在目前版本中，只有基线数据可以指定使用编码模式组织微块，对于转储数据全部默认使用平铺模式进行数据组织。
  
