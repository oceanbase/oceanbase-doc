# What's New

OceanBase 数据库 V4.3.2 是面向 AP 业务的性能增强版本。它在数据读取、数据分发、数据计算、向量化处理和计划选择等方面进行了全方位优化，AP 类基准测试性能整体提升了 10% 到 15%。 V4.3.2 版本引入了 RoaringBitmap 数据类型及相关计算表达式，为大数据集合运算和去重场景提供了更优的解决方案。此外，增量旁路导入功能得到了丰富，全量旁路导入的性能也得到了提升，还扩展支持了 Parquet 文件外部表，加快了大规模数据的处理速度。作为一款一体化数据库，OceanBase V4.3.2 针对五类场景（`express oltp`、`complex oltp`、`olap`、`htap`、`kv`）梳理了场景化参数模板，配合部署工具，让初始配置就适合每一种业务类型。V4.3.2 版本还融入了 V4.2.x 系列前序版本的多项兼容性增强和用户体验改进特性，并合并了 TP 类 SQL 的性能改进，致力于满足各类应用场景产品需求。

## 多模特性

### Oracle 模式 GIS 增强

在 OceanBase 数据库 V4.3.2 中，Oracle 模式下新增了以下 GIS 相关功能：

- **空间索引**：支持通过 `CREATE INDEX` 创建空间索引，空间索引列的 `SRID` 需要在建表时指定。更多详细信息，参见 [创建空间索引](700.reference/500.sql-reference/100.sql-syntax/300.common-tenant-of-oracle-mode/300.basic-elements-of-oracle-mode/100.built-in-data-types-of-oracle-mode/1200.spatial-data-type-of-oracle-mode/400.create-spatial-indexes-of-oracle-mode.md)。

- **函数**：新增 `SDO_RELATE` 表达式，用于确定两个空间几何对象之间的空间关系；新增 `SDO_GEOM.SDO_DISTANCE` 成员函数，用于计算两个空间几何对象之间的最小地球表面距离。更多详细信息，参见 [查询计算函数](700.reference/500.sql-reference/100.sql-syntax/300.common-tenant-of-oracle-mode/500.functions-of-oracle-mode/200.single-row-functions-of-oracle-mode/1400.spatial-functions-of-oracle-mode/300.sdo-geometry-query-functions-of-oracle-mode.md)。

### GIS 空间关系计算性能优化

V4.3.2 版本优化了 `ST_INTERSECTS`、`ST_CONTAINS`、`ST_COVERS`、`ST_WITHIN` 等空间关系计算表达式的计算性能：

- 在全量查询窗场景中，`point` 的 `st_intersects` 性能与 PG 持平，略优于 PG；其他测试场景的平均响应时间均不到 PG 的一半，其中 `linestring` 的 `intersect` 用时仅为 PG 的 1/5 ，相比 OceanBase 历史版本有数量级的提升。

- 在大查询窗场景中，所有场景的平均响应时间均明显优于 PG，其中 `linestring` 的 `intersect` 用时仅为 PG 的 1/7，且相比 OceanBase 历史版本有数量级的提升。

- 在小查询窗场景中，`contain` 计算优于 PG，其中 `point` 的 `contain` 用时约为 PG 的 1/4，`linestring contain` 用时约为 PG 的 4/5。但 `intersect` 计算性能在 `linestring` 场景中与 PG 持平，在 `point` 场景中用时为 PG 的 2 倍左右。

### OUTROW 存储的 LOB 读写性能优化

OceanBase 数据库 V4.3.2 针对 OUTROW 存储的 LOB 进行了重点优化：

- **Table Scan 场景**：V4.3.2 版本中小 LOB 性能相比旧版本提升近 10 倍，大 LOB 提升至少 2 倍，但相对 INROW 仍然慢一些。

- **Point Select 场景**：对于小 LOB（8K 以下），OUTROW 的 QPS 比 INROW 低 20% 以内；中等以上大小的 LOB（32K 以上），OUTROW 的 QPS 比 INROW 低 5% 左右。在 LOB 不参与计算的场景下，LOB OUTROW 存储对查询性能更优。

- **Point Update 场景**：V4.3.2 版本中 OUTROW 性能相比历史版本平均提升 2 倍。


## 内核增强

### RoaringBitmap

随着大数据时代的到来，企业对用户数据的挖掘和分析需求日益增强。RoaringBitmap 凭借节省空间和计算高效的特点，在用户画像、精准营销等业务场景中发挥重要作用。OceanBase V4.3.2 在 MySQL 模式下引入了 RoaringBitmap 数据类型，支持用于基数计算、集合运算、Bitmap 判断、Bitmap 构造和聚合运算的多项表达式，从而提升大数据集合计算和去重性能。

### 表级覆盖写

为了满足数据仓库中数据定期刷新、数据转换和数据清洗修正的需求，OceanBase V4.3.2 新增了表级覆盖写能力（`INSERT OVERWRITE`）。该功能原子实现表内旧数据清空和新数据写入，且基于全量旁路导入能力，`INSERT OVERWRITE` 也体现出较高的执行性能，暂不支持分区级覆盖写。更多详细使用信息，参见 [插入数据（MySQL 模式）](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000001050302) 和 [插入数据（Oracle 模式）](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000001050262)。

### 增量旁路导入功能增强

V4.3.2 新增支持对 `outrow lob` 数据进行增量旁路导入的能力，并扩展 `load_mode` 为 `inc` 取值，默认采用 `insert` 语义，在 SQL 中指定 `ignore` 关键字时，表现为 `ignore` 语义。更多详细使用信息，参见 [使用 LOAD DATA 语句旁路导入数据](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000001049873) 和 [使用 INSERT INTO SELECT 语句旁路导入数据](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000001049871)。

### 外表功能增强

V4.3.2 开始支持 Parquet 文件外表，用户可通过外表将文件数据导入 OceanBase 内表，或直接用于跨数据源的联合查询分析。V4.3.2 版本增加了文件目录自动刷新功能，通过 `AUTO_REFRESH` 选项指定文件列表的刷新方式，并结合 `DBMS_EXTERNAL_TABLE.REFRESH_ALL_TABLE` 系统包管理定时刷新任务。更多详细使用信息，参见 [创建外表](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000001053138)。

### 向量化引擎增强

基于向量化引擎，V4.3.2 版本继续增加了一批算子及表达式，如 `Hash Set` 相关算子、`WindowFunction` 算子、`MergeDistinct` 算子，`repeat`、`ceil`、`floor` 等表达式，进一步优化 AP 场景计算性能。

### 分场景参数模版

OceanBase 作为一款一体化数据库，支持多种业务类型，如 `express oltp`、`complex oltp`、`olap`、`htap`、`kv` 等。V4.3.2 基于不同业务类型，区分不同场景梳理关键参数的最佳配置，配合 OCP、OBD 等工具进行分业务场景初始化。更多详细信息，参见 [最佳实践](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000001049824)。

### 查询解析能力增强

对于个数特别多的 `INLIST`、`AND`/`OR`、`UNION` 的查询，V4.3.2 版本重写了这些极端场景下的查询解析实现，降低了解析阶段资源消耗，增强了极端 SQL 执行的稳定性，并提升了 SQL 解析性能。

### 查询改写能力增强

OceanBase V4.3.2 优化器从多个方面强化了查询改写逻辑，提高了查询性能：

- **表达式规范化强化**：历史版本在解析阶段会规范化表达式，例如将 `A AND (A OR B)` 改写为 `A`，但没有覆盖到 SQL 改写阶段的新表达式。V4.3.2 版本引入改写阶段的表达式规范化流程，将表达式简化到最优状态。
- **条件聚合函数改写**：支持将条件聚合函数（如 `SELECT c1, SUM(CASE WHEN c2 = 0 THEN c3 ELSE 0 END) ... FROM t1 GROUP BY c1`）中的聚合函数压入每个分支的选择目标上，减少 `CASE WHEN` 表达式和聚合函数的计算次数，提升执行性能。
- **多 `MIN`/`MAX` 改写**：在 `scalar group by` 中，若查询有多个 `MIN`/`MAX` 聚合函数且这些列有索引，可以改写为 `ORDER BY xxx LIMIT 1`。V4.3.2 版本将这种场景改写为多个子查询，通过索引直接获取最大值或最小值，避免全表扫描和排序。
- **常量 `UNION` 改写 `Values Table`**：V4.3.2 版本对于多个 `UNION ALL`/`UNION` 形式的常量表，改写为 `Values Table` 查询，显著降低硬解析阶段的资源消耗。
- **`SEMI JOIN` 拆分优化**：对于没有连接条件的多表关联子查询（如 `EXISTS` 或 `IN` 子查询），V4.3.2 版本支持 `SEMI JOIN` 拆分改写，避免笛卡尔积带来的性能开销。

### 计划选择优化

V4.3.2 在计划选择上进行了多项优化：

- **改进 `NOT IN` 表达式生成的 Query Range**：优化了 Query Range 抽取性能，支持 Range Graph 裁剪，减少抽取的最终 Query Range 数量，降低内存消耗。
- **扩展 `index` Hint**：如 `/*+index(t1 k1 1)*/` 仅对 `k1` 索引的第1列进行 Query Range 抽取。
- **支持 `interesting ordering` 索引路径裁剪和 `LIMIT` 重计算**：优化了 `ORDER BY LIMIT` 场景中的计划选择，提升查询性能。

### 产品行为兼容版本控制

为了减少因为 V4.3.2 版本行为变更导致升级后报错的问题，OceanBase V4.3.2 引入了产品行为兼容版本控制功能：

- **通过 `ob_compatibility_version` 和 `ob_security_version` 系统变量** 控制普通行为变更（如不报错到报错场景）和安全行为变更（如有权限到无权限）。
- **版本控制示例**：如一个功能在 V4.3.3 发生产品行为变更，变量取值为 4.3.2.0 时，使用旧行为；取值为 4.3.3.0 时，使用新行为。

通常升级场景不会自动推高该版本号，需要 V4.3.2 版本行为时，请升级后，了解V4.3.2 版本行为并测试后，修改为和当前版本一致的版本号。该方案仅用于控制未来新增的产品行为变更，无法控制已经发版的存量产品行为变更。

通过 `ob_compatibility_version` 控制的产品行为示例：
- `ob_compatibility_control` 设置为 `MYSQL5.7` 时，`REPLACE('abd', '', null)` 行为从 MySQL 8.0 兼容性修改为 MySQL 5.7 兼容性。
- 禁用 `UPDATE/DELETE` 语句中的 `limit` 和 `offset`。
- 单独的 `null` 值返回的表头会修改为 `NULL`。
- 用户变量最长限制为 64 字符。

通过 `ob_security_version` 控制的产品行为示例：
- 增加对 `Outline` 和 `Sequence` 的权限管控。
- 新增 `CREATE TABLESPACE` 权限。

## 性能提升

### AP 典型场景性能优化

V4.3.2 对多个方面进行了优化，提升了 AP 场景的计算性能：
- **优化点**：数据块预取、向量化批处理、Filter 下压、比较计算、聚合计算、DTL shuffle、单调性 Filter 等。
- **测试结果**：在 100G 数据量下，TPCH、TPCDS、ClickBench 等多基准测试场景的性能相比 V4.3.1 提升了约 10%～15%。

### 全量旁路导入性能优化

在 V4.3.2 版本中，全量旁路导入性能提升了约 20%，关键措施包括减少数据加载过程中的列类型转换操作，降低统计信息收集操作的 CPU 占用，去除 `INSERT INTO SELECT` 中 `SELECT` 端生成PK的逻辑，以及默认关闭列存的 `sum skip index` 功能，并结合配置项 `micro_block_merge_verify_level` 设置为 0 以关闭微块校验等。

### IN/EXISTS 子查询提升改写

在 V4.3.2 中，OceanBase 支持部分场景下将 `SELECT` 子句中的 `IN`/`EXISTS` 子查询的提升改写，尽量将子查询改写为连接形态，充分利用并行提升 SQL 执行性能。

### 存储过程 DDL 执行编译结果缓存和落盘

V4.3.2 版本补充支持存储过程 DDL 执行成功后将编译结果缓存到 PL Cache 并落盘的行为，后续执行存储过程时，提升直接命中 PL Cache 缓存的概率，进一步提高存储过程执行性能。

### Oracle 模式下空表加 not null 列性能优化

V4.3.2 将对空表加 `not null` 列的操作转换为在线流程，较多分区下性能提升数倍，相比 `add column null` 操作，效率得到显著提升。

### Show Table Status 性能优化

V4.3.2 版本针对带有单表过滤条件的 `SHOW TABLE STATUS FROM ... LIKE ...` 场景大幅提升了查询性能。

### 自增列 Order 模式性能优化

V4.3.2 优化了 Order 模式下自增列的性能，通过 `cache size` 预取有效降低内部表访问次数，提升在高并发情况下的响应速度。

### Sequence Order 模式性能优化

V4.3.2 版本针对指定 order + cache 属性来创建全局连续生成的序列进行了优化，实现了真正的 cache 属性，通过选取中心节点显著提升了高并发场景下的执行性能。

## 可靠性

### 备租户克隆

自 V4.3.0 起，OceanBase 提供了租户克隆功能，用户可以在不影响在线租户的情况下进行高资源消耗的临时数据分析或其他高风险操作。然而，V4.3.2 之前的版本仅支持对主租户的克隆操作，这在同步与回放优先级高于克隆的场景下，无法确保稳定性。V4.3.2 版本增加了**备租户克隆**功能，允许用户通过克隆备租户进行业务验证或容灾操作，不会阻塞备租户的日志回放，降低了系统稳定性影响。

### Transfer 事务影响优化

从 OceanBase 数据库 V4.3.0 开始，OceanBase 支持 Transfer 搬迁活跃事务。在 V4.3.2 版本中，进一步优化了 Transfer 对事务执行的影响。如果 Transfer 源端日志流上的事务没有操作过迁移的 tablet，则变更为不阻塞事务提交，不迁移这些事务，尽量使前台业务无感知，负载均衡更加透明。

### 网络备库性能优化

V4.3.2 版本对 RPC 及网络框架进行优化，降低了主备库之间的日志传输耗时；同时优化了备库受控拉日志流程，减少了备租户拉日志受控的频率，提高了主备之间的日志同步性能。

### 备份性能优化

OceanBase 在备份过程中通过连续性校验确保基线版本大于转储版本以保证数据完整，但这涉及读取备份介质上的数据并执行带锁操作，影响备份性能。V4.3.2 版本优化了备份过程中连续性校验操作的性能开销，并支持通过 `ha_low_thread_score` 控制备份使用的线程数，从而有效提升备份性能。

### 迁移复制源端选择优化

历史版本在选择迁移复制源端时未优先考虑同 Zone、同 IDC（同机房）、同 Region（同城）的副本，这可能导致远距离迁移复制性能不佳的问题。V4.3.2 版本将各 Server 按照地域信息划分为同 IDC、同 Region 不同 IDC、跨 Region 三种区域关系，并提供 `choose_migration_source_policy` 枚举配置项，支持用户配置指定迁移复制的源端优先模式，以优先考虑地理位置和 Follower 副本，提升迁移效率并降低 Leader 压力。

### SET/PIECE 级物理恢复

OceanBase 数据库 V4.3.0 增加了 `SET`/`PIECE` 级物理恢复功能，提供 `ADD RESTORE SOURCE` 命令来加载新路径的数据备份集 `SET` 或日志归档 `PIECE`，允许按需恢复到指定时间，增强了恢复操作的灵活性。

## 资源优化

### 分区局部索引空间优化

在后建索引流程中，通过发送内部 SQL 加载索引表数据，如果某节点数据量很大，在排序过程中可能引起临时空间放大。V4.2.2 版本支持索引表补数据的渐进式执行，通过单机 1GB 数据量同一批次执行，多机任务并行执行，这样在充分利用分布式系统并行计算的同时，也解决了索引构建过程中出现的临时空间放大问题。

### 全局 CPU 前后台任务隔离

在高性能计算环境中，资源的合理分配与隔离对于系统稳定性和效率提升至关重要。OceanBase 通过租户 Unit 规格和 `DBMS_RESOURCE_MANAGER` 系统包实现了租户间和租户内的资源隔离，但对于租户数量较多且不希望后台任务对前台请求造成严重 CPU 竞争的业务，更好的选择是在全局层面上对后台任务进行隔离。V4.3.2 版本支持全局 CPU 前后台任务隔离能力，在整体层面限制后台任务的可用资源，使配置更加方便易用。

## 安全

### MySQL CREATE TABLESPACE 权限

新增 `CREATE TABLESPACE` 权限，仅适用于 TDE（透明数据加密）场景。

### MySQL 模式增加 Outline、Sequence 权限管控（非兼容特性）

历史版本缺乏创建和维护 Outline、Sequence 的权限管控。V4.3.2 版本复用 MySQL `CREATE`、`ALTER`、`DROP` 权限，控制 Outline 和 Sequence 的创建、修改和删除。

## 易用性

### Buffer 表自适应合并优化

当用户在某张表上频繁执行插入并同时进行批量删除，或有大量并发更新操作时，可能会遇到表中的数据行数并不多，但查询和更新性能明显下降的现象，这种现象在 OceanBase 中称为 Queuing 表效应。为了更灵活地解决 Buffer 表带来的性能下降问题，V4.3.2 版本优化了 Buffer 表自适应合并特性，提供了 5 种档位的合并策略，允许用户根据业务场景设置每张表的 `table_mode`，应对 Buffer 表引起的读放大现象，提高系统长时间运行下的性能指标。

### 系统日志优化

在系统日志目录下，新增加了 `./alert/alert.log` 日志文件，用于记录 DBA 关注的日志信息，解决 `observer.log` 日志量大、可读性差的问题。可通过 `alert_log_level` 集群配置项设置日志级别，包括 `INFO`、`WARN`、`ERROR` 等。此外，还提供系统外部表 `sys_external_tbs.__all_external_alert_log_info` 以便直接结构化查询 `alert.log` 日志信息。更多详细信息，请参见 [日志概述](600.manage/800.logging/100.logging-overview.md)。

### OceanBase LogMiner

V4.3.2 版本新增 OceanBase LogMiner（简称 ObLogMiner）工具，用于对 OceanBase 数据库进行日志分析。ObLogMiner 支持在线和离线日志分析，通过 OBCDC 拉取并解析 CLOG 日志，并将 OBCDC 输出的逻辑日志转化为易读格式存储，适用于数据误操作分析和数据分析等场景。

### 自增列 Cache Size 表级设定

当前已支持通过指定租户级配置项 `auto_increment_cache_size` 控制自增列缓存的大小，并对所有使用自增列的表生效。V4.3.2 版本新增自增列 cache size 表级设定功能，用户可以根据列类型、业务模型和业务流量自定义不同表的缓存大小，平衡跳变和性能。

### PX 诊断能力增强

为方便分布式计划的问题排查，V4.3.2 版本在 SQL Plan Monitor 中增加了关于算子运行时内存和磁盘使用量的记录信息，在 SQL Audit 中增加了 QC 对应 `trace_id` 下的 `memtable`、`sstable` 行数信息，并支持汇总各 PX Worker 对应 `trace_id` 下的相关信息。同时也支持了 OBDiag 工具依据 trace_id 拉取最初报错机器日志的功能。

## 兼容性增强

### MySQL 兼容

- **区分 MySQL 5.7 和 8.0 兼容版本**：新增租户级初始化变量 `ob_compatibility_control`，用于在创建租户时指定兼容 MySQL 5.7 或 8.0 的行为。租户创建后不可修改，两种模式下均可使用不存在行为冲突的 MySQL 5.7/8.0 的特性超集。
- **Union Distinct RCTE**：新增对 MySQL 8.0 中 Recursive Union Distinct 功能的支持，保证输出数据唯一性。并加强了 Recursive Union All 功能，支持可使用内存不足时进行数据落盘。
- **自增列切主跳变优化**：主动切主时保留自增列的连续性，降低自增列跳变概率。
- **自增列改小**：支持通过 `ALTER TABLE` 将 `AUTO_INCREMENT` 值改小的功能，指定新值大于自增列已存在的最大值时，可以设置成功且生效；指定新值小于或等于自增列已存在的最大值时，可以设置成功，但 `AUTO_INCREMENT` 会自动调整为自增列已存在的最大值的下一个值。更多详细信息，参见[定义自增列](700.reference/300.database-object-management/100.manage-object-of-mysql-mode/200.manage-tables-of-mysql-mode/300.define-an-auto-increment-column-of-mysql-mode.md)。
- **SERIAL 数据类型**：新增 `SERIAL` 数据类型，作为 `BIGINT UNSIGNED NOT NULL AUTO_INCREMENT UNIQUE` 属性别名，表示一个自动递增的大整数，适合作为表的主键。更多详细信息，参见[整数类型](700.reference/500.sql-reference/100.sql-syntax/200.common-tenant-of-mysql-mode/100.basic-elements-of-mysql-mode/100.data-type-of-mysql-mode/200.numeric-of-mysql-mode/200.integer-type-of-mysql-mode.md)。
- **补充支持 MySQL 通信协议命令字**：兼容 MySQL 5.7 通信协议的 `COM_PROCESS_INFO` 和 `COM_PROCESS_KILL` 命令字。

### Oracle 兼容

- **DBMS_SCHEDULER 功能增强**：扩展了 `JOB CLASS`、`PURGE LOG`、`STOP JOB` 等功能，并优化了 `JOB` 路由策略。
- **UTL_RECOMP 包**：实现了 `UTL_RECOMP` 系统包，支持重新编译 `PACKAGE`、`PROCEDURE`、`FUNCTION`、`TYPE`、`TRIGGER` 等S护具看对象，在升级或 PL 对象迁移场景，可以使用该系统包来批量确认对象的有效状态。为避免产生大量 IO 操作，仅供 SYS 用户使用。
- **DBMS_PROFILER 包**：支持 `DBMS_PROFILER` 系统包，用于性能剖析，记录更细粒度的执行时间。
- **DBLink 同义词**：支持在 PL 中使用 DBLink 对象同义词定义变量类型，但不适用于 PL 参数列表。
- **Proxy User**：支持 Oracle Proxy User 功能，简化账号维护，提高安全性。
- **SELECT ... FOR UPDATE 支持层次查询**：支持 `SELECT ... FOR UPDATE` 与 `START WITH ... CONNECT BY` 语句结合使用。更多详细信息，参见 [层次查询](700.reference/500.sql-reference/100.sql-syntax/300.common-tenant-of-oracle-mode/800.queries-and-subqueries-of-oracle-mode/300.hierarchical-query-of-oracle-mode.md)。

## 相关文档

请关注我们的版本发布记录，了解更多 OceanBase 各版本信息：

- [企业版 V4.3.1 版本发布记录](https://www.oceanbase.com/product/oceanbase-database-rn/releaseNote#V4.3.2)
