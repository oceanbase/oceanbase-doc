# What's New

OceanBase V4.2.4 是面向 TP 和 HTAP 业务的高度兼容、高性能、安全且易于管理的新版本。在 V4.2.3 版本基础上，新版本继续完善产品兼容性，新增多项 MySQL 特性支持，包括 Event Scheduler、ASCII/TIS620 字符集、列默认值定义为表达式等，提升 MySQL 迁移的便利性；支持 DBLink 跨 Oracle 租户远程调用存储过程，增强 PL 报错堆栈的准确性，丰富 `DBMS_SCHEDULER` 子功能等，助力 Oracle 业务的平滑迁移。增强优化器能力，支持统计信息过期后的自适应修正，优化直方图采样策略，提升估行准确性以防统计信息走偏。新版本也实现了主备库之间的自动路由功能，确保服务高可用性，即使在主库故障情况下也能无缝切换至备库继续提供服务。提升 PDML 高并发性能，优化 DAS 执行 GTS 开销，支持物理备库的并行同步，整体提升了小规格 OLTP 性能。另外新增了 MySQL 模式审计功能，支持 REFERENCES、CREATE/DROP ROLE、TRIGGER 权限管理，强化数据库企业级安全特性。运维易用性方面，扩展分区均衡的运维能力，优化死锁检测诊断机制，重构 ASH 报告内容展示，提升实时诊断准确性，提升了用户操作的便捷性和效率。同时重构了 OBKV 请求的 `SQL_ID` 生成方式，提升 OBKV 可观测性。

有关 V4.2.4 版本全量的新功能、能力增强以及产品行为变更、使用限制等信息，可以查看 [V4.2.4 版本 Release Notes](https://www.oceanbase.com/product/oceanbase-database-rn/releaseNote#V4.2.4)。

以下为新版本迭代的主要内容。

## 高性能内核

### 估行与统计信息增强

  针对一些复杂场景，V4.2.4 版本进行了优化器代价估计的补充完善，优化了直方图收集采样策略，将直方图和基础统计信息收集解耦，新增统计信息收集参数 `hist_est_percent` 和 `hist_block_sample`。为了优化直方图收集性能，新版本会根据表大小自适应选择直方图收集的采样方式，小表使用行采样，大表使用块采样。更多有关估行与统计信息增强的内容，参见[统计信息和估行机制的使用](./600.manage/900.performance-tuning/400.sql-tuning/200.execution-plan-optimization/100.statistics-and-cost-based-optimization/400.use-statistic-information-and-cost-based-optimization.md)。

## 更高的兼容性

### MySQL 兼容

* **Event Scheduler**

  MySQL 模式下新增 Event Scheduler（事件调度器） 功能，用于定时执行 SQL 或匿名块语句，适用于定时任务执行、周期性数据维护等场景。将事件调度器集成到数据库中，减少了对外部调度工具的依赖，简化了运维操作。更多内容参见 [CREATE EVENT](./700.reference/500.sql-reference/100.sql-syntax/200.common-tenant-of-mysql-mode/600.sql-statement-of-mysql-mode/2950.create-event-of-mysql-mode.md)、[ALTER EVENT](./700.reference/500.sql-reference/100.sql-syntax/200.common-tenant-of-mysql-mode/600.sql-statement-of-mysql-mode/1950.alter-event-of-mysql-mode.md) 和 [DROP EVENT](./700.reference/500.sql-reference/100.sql-syntax/200.common-tenant-of-mysql-mode/600.sql-statement-of-mysql-mode/3450.drop-event-of-mysql-mode.md)。

* **Authentication method Switch**

  V4.2.4 版本支持了 `Authentication method Switch`，当原生客户端使用 OceanBase 数据库时不支持的认证方式创建连接时，服务端会发送 `AuthSwitchRequest` 给客户端，告知客户端使用服务端支持的认证方式重新开始认证。

* **字符集/字符序扩展**

  新增支持 ASCII 字符集（`ascii_bin`、`ascii_general_ci` 字符序），TIS620 字符集（`tis620_bin`、`tis620_thai_ci` 字符序）。另外 `utf8mb4` 字符集扩展了 `utf8mb4_unicode_520_ci`、`utf8mb4_croatian_ci`、 `utf8mb4_czech_ci`、`utf8mb4_0900_ai_ci` 等字符序，并支持了 `utf8mb3` 字符集（作为 `utf8mb4` 别名）。更多内容参见[字符序](./700.reference/500.sql-reference/100.sql-syntax/200.common-tenant-of-mysql-mode/100.basic-elements-of-mysql-mode/300.character-set-and-collation-of-mysql-mode/300.collation-of-mysql-mode.md)。

### Oracle 兼容

* **Oracle 租户间支持使用 DBLink 进行存储过程远程调用**

  支持 Oracle 租户间通过 DBLink 调用原生 Oracle 的存储过程。更多内容参见[PL Database Link](./700.reference/500.sql-reference/300.pl-reference/300.pl-oracle/700.stored-procedure-and-functions-oracle/900.pl-databaselink.md)。

* **DBMS_SCHEDULER 功能完善**

  优化了 Job 路由规则，支持通过 `DBMS_SCHEDULER.SET_ATTRIBUTE` 设置 Job 路由策略。通过配置 Job 路由至 Leader 节点，降低 RPC 开销，提升执行性能。另外新增 `DBMS_SCHEDULER.STOP_JOB` 子程序，用于终止正在运行的 Job，便于出现异常时进行 Job 管理。更多内容参加见[STOP_JOB](./700.reference/500.sql-reference/300.pl-reference/300.pl-oracle/1400.pl-system-package-oracle/14200.dbms-scheduler-oracle/1300.stop-job-oracle.md)。

## OBKV 增强

  重构 OBKV 请求的 `SQL_ID` 生成方式，将请求拆分为多个单操作，并参考 SQL 参数化的方式，将 OBKV 单操作进行参数化后生成新的 `SQL_ID`。基于新的 `SQL_ID` 生成方式，外围工具也可对 OBKV 请求进行分类，识别高频操作和超长耗时操作等，提高 OBKV 诊断易用性。

## 性能提升

### 小规格（4C、8C）性能优化

  针对 4C、8C 规格集群，通过多场景优化提升系统性能，如多索引场景下的写入优化、Update 路径下 `rowkey_exist` 检查开销优化、Memtable hash 索引开销优化、Plan cache hash key 优化等，OLTP 相关 Case 性能相对 V4.2.3 版本提升约 20%。

### 物理备库并行同步

  设计和实现了新的同步模型，支持网络备库从主库并行同步日志，增强网络备库的日志同步能力，提升同步性能。更多内容参见[优化日志同步性能](./600.manage/400.high-availability/300.physical-standby-database-disaster-recovery/300.log-transport-service/600.optimize-log-synchronization-performance.md)。

## 资源优化

### 内存限速机制

  提供更细致的手段来控制多个模块的内存使用，新增 TxData 和 MDS 模块内存上限控制，和 Memtable 共享内存空间，当累积内存达到 `租户内存 * _tx_share_memory_limit_percentage% * writing_throttling_trigger_percentage%` 时，触发整体限速。同时，增加时间维度触发事务数据表冻结转储的功能，默认 1800 秒触发一次事务数据表的冻结，降低事务数据模块的内存占用。

## 更高的可靠性

### 主备库自动路由

  新版本引入 `SERVICE_NAME` 概念，用于管理一组主备租户。同时，系统租户下也提供了一套 `SERVICE_NAME` 管理命令，用于为租户创建、删除、启动、停止 `[SERVICE_NAME](./700.reference/500.sql-reference/100.sql-syntax/100.system-tenants/200.alter-system/3650.service-name.md)`。

## 更强的安全性

### MySQL 模式审计

  在 MySQL 模式下新增数据库审计功能，通过过滤器来设置需要被审计的请求类型。支持平台读取，也可配合 OceanBase 数据库外表能力在数据库内直接进行审计记录读取分析。

### MySQL REFERENCES/CREATE ROLE/DROP ROLE/TRIGGER 权限

  兼容 MySQL `References，Create Role，Drop Role，Trigger` 权限。

  为了保证旧版本升级后不影响在线业务，升级场景默认不开启以上权限校验，确认需要使用新版本权限功能时，可通过 `ob_security_version` 变量手动设置安全功能版本，该版本号只能推高，不能回退。新建集群时默认开启。更多内容参见 [MySQL 模式下的权限分类](./600.manage/500.security-and-permissions/300.access-control/200.user-and-permission/200.permission-of-mysql-mode/100.permission-classification-of-mysql.md)。

## 更高的易用性

### 定时/手动分区均衡

 新增 `DBMS_BALANCE` 系统包，为用户提供手动触发分区均衡的方法 `DBMS_BALANCE.TRIGGER_PARTITION_BALANCE(balance_timeout)` ，同时在用户租户创建时内置了定时分区均衡任务 `SCHEDULED_TRIGGER_PARTITION_BALANCE`，用户也可根据业务特点通过 `DBMS_SCHEDULER` 子程序修改定时调度的时间、频率等信息，以便更加灵活、可靠地管理分区均衡任务。更多内容参见[DBMS_BALANCE](./700.reference/500.sql-reference/300.pl-reference/300.pl-oracle/1400.pl-system-package-oracle/2700.dbms-balance-oracle/100.dbms-balance-overview-oracle.md)。

### 死锁检测优化

  丰富死锁检测的视图信息，补充 Visitor 对应的 SESSION ID，申请资源所在的机器、日志流、Tablet 地址等信息，并记录了事务发生死锁后当前正在执行的 SQL、持锁的 SQL 及请求时间，方便死锁事件诊断。更多内容参见[DBA_OB_DEADLOCK_EVENT_HISTORY](./700.reference/700.system-views/400.system-view-of-mysql-mode/200.dictionary-view-of-mysql-mode/8200.o-dba_ob_deadlock_event_history-of-mysql-mode.md)。

### ASH REPORT 增强

  扩展 ASH Report 租户级别分析能力，支持通过 `DBMS_WORKLOAD_REPOSITORY.ASH_REPORT` 指定生成 ASH Report 的租户 ID 。优化 ASH Report 展示内容，在借鉴 Oracle ASH 框架基础上，将报告调整地更适用于 OceanBase 数据库性能诊断。为了增强可读性，新版本还支持了输出 HTML 格式的 ASH 报告。更多内容参加[生成 ASH 报告](./700.reference/1000.performance-tuning-guide/400.performance-diagnosis/500.ash-report-diagnosis/200.generate-ash-report.md)。

### 实时诊断能力增强

  基于 SQL PLAN MONITOR 补充了 TABLE SCAN 算子的实时行数、实时字节数等信息。更多内容参加[TABLE SCAN](./700.reference/1000.performance-tuning-guide/500.sql-optimization/200.sql-execution-plan/200.execution-plan-operator/100.table-scan.md)。

### 资源规格估算

  新增资源规格估算功能，提供以下一系列动态视图、系统包：

* 新增 `[G]V$OB_TENANT_RESOURCE_LIMIT` 视图，用于展示租户在每个 Unit 上的逻辑资源使用量、上限值、生效限制条件和宕机重启后的最大占用量。更多内容参见[V$OB_TENANT_RESOURCE_LIMIT](./700.reference/700.system-views/500.system-view-of-oracle-mode/300.performance-view-of-oracle-mode/34100.v-ob_tenant_resource_limit-of-oracle-mode.md)。
* 新增 `[G]V$OB_TENANT_RESOURCE_LIMIT_DETAIL` 视图，用于展示租户在一个机器上能创建的逻辑资源所受的物理资源或配置项的限制情况。更多内容参见[V$OB_TENANT_RESOURCE_LIMIT_DETAIL](./700.reference/700.system-views/500.system-view-of-oracle-mode/300.performance-view-of-oracle-mode/34200.v-ob_tenant_resource_limit_detail-of-oracle-mode.md)。
* 新增 `DBMS_OB_LIMIT_CALCULATOR.CALCULATE_MIN_PHY_RES_NEEDED_BY_UNIT` 子程序，用于计算某个租户在某个节点上所需的最小物理资源量。更多内容参见[CALCULATE_MIN_PHY_RES_NEEDED_BY_UNIT](./700.reference/500.sql-reference/300.pl-reference/200.pl-mysql/1000.pl-system-package-mysql/20900.dbms-limit-calculator-mysql/200.calculate-min-phy-res-needed-by-unit-mysql.md)。
* 新增 `DBMS_OB_LIMIT_CALCULATOR.CALCULATE_MIN_PHY_RES_NEEDED_BY_LOGIC_RES` 子程序，用于计算特定逻辑资源类型和数量需要的物理资源量。更多内容参见[CALCULATE_MIN_PHY_RES_NEEDED_BY_LOGIC_RES](./700.reference/500.sql-reference/300.pl-reference/200.pl-mysql/1000.pl-system-package-mysql/20900.dbms-limit-calculator-mysql/300.calculate-min-phy-res-needed-by-loglc-res-mysql.md)。
* 新增 `DBMS_OB_LIMIT_CALCULATOR.CALCULATE_MIN_PHY_RES_NEEDED_BY_STANDBY_TENANT` 子程序，用于计算指定主租户创建指定 Unit 个数的备租户需要的最小物理资源量。更多内容参见[CALCULATE_MIN_PHY_RES_NEEDED_BY_STANDBY_TENAN](./700.reference/500.sql-reference/300.pl-reference/200.pl-mysql/1000.pl-system-package-mysql/20900.dbms-limit-calculator-mysql/400.calculate-min-phy-res-needed-by-standby-tenant-mysql.md)。

### 手动 Transfer Partition 功能增加 Cancel 能力

  Cancel Transfer Partition 是对手动 Transfer Partition 功能的完善。用户在发起手动 Transfer Partition 任务后，任务在没有执行完成之前可以尝试取消任务。本功能提供如下能力：可以指定取消尚未开始 TRANSFER 的任务；可以取消租户下所有没有开始 TRANSFER 的任务；可以取消当前正在执行的 Balance Job。更多内容参见[Transfer Partition](./600.manage/300.replica-management/500.load-balancing-manage/200.transfer-partition-management.md)。
