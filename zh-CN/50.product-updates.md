# What's New

OceanBase 数据库在经过了新一轮的优化与提升后，迎来了 V4.2.3 新版本。该版本支持了一系列 MySQL 兼容特性，如角色、列级权限、Union Distinct RCTE 及大量小功能兼容；也支持了 Proxy User、UTL_RECOMP、DBMS_PROFILER、DBLink SAVEPOINT 等业务需要的多个 Oracle 功能。新版本在多个场景优化了系统性能，如优化多模类型的读写计算性能和 OBKV 执行效率，扩展 Batch DML 的并行执行能力，提升备份/网络备库性能，解决自增列/Sequence 在 Order 模式下的性能问题等。同时，备份恢复扩展支持了 S3/OBS/GCS 等对象存储，补充支持了 SET/PIECE 级物理恢复功能，丰富了备份恢复的可选路径。新版本也实现了多个业务期待的易用性功能，如用于日志分析、误操作识别的 ObLogMiner 功能，应对 Buffer 表性能问题的合并策略选择，提供模糊绑定计划和限流方式的 Format Outline，用于识别无用索引的索引使用监控特性，提供更高可读性的面向 DBA 的 alert.log 系统日志，日志流副本管理的用户命令，更详细的 PX 诊断数据以及 ASH Report 的节点级分析等，有效提高系统易用性。

有关 V4.2.3 版本全量的新功能、能力增强以及产品行为变更、使用限制等信息，可以查看 V4.2.3 版本Release Notes。

以下为新版本迭代的主要内容。

## 高性能内核

### 查询解析能力增强

SQL 中存在个数特别多的 INLIST 、AND/OR、UNION 时，往往会产生超深语法树解析，进而造成内存消耗过大、栈不足、耗时过长的问题。新版本重写这些极端场景的查询解析实现，降低了解析阶段资源消耗，增强了极端 SQL 执行的稳定性，同时提升了 SQL 解析性能。例如 select sum(c1) from t1 where c1 in (1, 2, 3, ...N) 中 N = 20 万的查询场景，新版本的解析性能相对 V4.2.2 可以提升 20%-30%。

### 查询改写能力增强

新版本优化器从多个方面优化了查询改写逻辑。例如，表达式规范化强化、条件聚合函数改写、多 Min/Max 改写、常量 UNION 改写 Values Table、SEMI JOIN 拆分优化。

### 自适应代价模型

新版本优化代价模型实现，支持通过 DBMS_STATS 包来收集或设置系统统计信息系数，以达到代价模型自适应硬件的目的。同时也提供了 DBA_OB_AUX_STATISTICS 视图，用于展示当前租户的系统统计信息系数。

更多信息，参见[DBMS_STATS 概述](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000752764)。

### 复制表属性变更

新版本提供复制表属性变更功能，可通过 ALTER TABLE 命令实现表属性转换，降低用户操作成本。

更多信息，参见[更改复制表属性](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000751190)。

### 产品行为兼容版本控制

新版本新增产品行为兼容版本控制功能，支持通过 ob_compatibility_version、ob_security_version 系统变量，分别控制普通行为变更（不报错->报错场景）、安全行为变更（有权限->无权限）是否生效，一个租户中的兼容功能或安全功能按照哪个 OceanBase 版本来兼容，取值范围为 "4.2.3.0" 等发行版本。该方案仅用于控制未来新增的产品行为变更，无法控制已经发版的存量产品行为变更。

更多信息，参见[ob_compatibility_version](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000751932) 和 [ob_security_version](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000751947)。

## 更高的兼容性

### MySQL 兼容

* MySQL 角色：兼容 MySQL 8.0 的角色管理功能，通过角色来管理维护一组权限，可以更方便地对某一类用户进行授权和回收。更多信息，参见[角色管理](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000752642)。
* MySQL 列级权限：新增 MySQL 列级权限功能，可以用于控制用户是否有权限对某张表的某几列进行 SELECT、INSERT 或 UPDATE。更多信息，参见[MySQL 模式下的权限分类](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000752002)。
* MySQL 模式增加 Outline、Sequence 权限管控：复用 MySQL CREATE、ALTER、DROP 权限，控制 Outline、Sequence 的创建、修改和删除。更多信息，参见[CREATE SEQUENCE](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000752534)。
* 自增列切主跳变优化：主动切主时仍保持自增列连续性，降低自增列跳变概率。
* 自增列改小：支持了 AUTO_INCREMENT 值改小的功能。更多信息，参见[定义自增列](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000751258)。
* Union Distinct RCTE：支持 CTE 的 Recursive Union All 及 Recursive Union Distinct 功能。更多信息，参见[UNION](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000752055)。
* MySQL 模式下区分 MySQL 5.7/8.0 兼容版本：新增租户级初始化变量 ob_compatibility_control，用于在创建租户时指定存在产品行为冲突的情况是兼容 MySQL 5.7 版本，还是 8.0 版本。更多信息， 参见[ob_compatibility_control](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000751811)。
* 语法/变量/视图新增多个支持。更多信息，参见[innodb_compress_debug](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000751903)。

### Oracle 兼容

* UTL_RECOMP 包：支持 UTL_RECOMP 系统包，可以在数据库升级后用来做数据库对象的有效性检查。更多信息，参见[UTL_RECOMP 概述](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000752858)。
* DBMS_PROFILER 包：支持 DBMS_PROFILER 系统包，完善新的性能剖析机制，记录更细粒度的执行时间，准确掌握 PL 每一行的执行性能，从而有效诊断 PL 运行时的性能问题。更多信息，参见[DBMS_PROFILER 概述](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000753102)。
* DBLink 同义词：支持在 PL 中使用 DBLink 对象同义词定义变量类型的行为，但不适用于 PL 参数列表。更多信息，参见[创建 DBLink](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000751218)。
* DBLink 事务 SAVEPOINT：支持 SAVEPOINT 功能，基于 XA 事务实现本地分支和远端分支事务的开启、提交、回滚。更多信息，参见[]()。
* Proxy User：兼容 Oracle Proxy User（代理用户） 功能，可以通过授权用户 Y 作为生产账号 X 的代理用户而无需知晓用户 X 的登录密码来临时登录用户 X，账号使用完成后，清除 Y 用户或取消代理权限即可，简化了账号维护的运维成本，提高了安全性。更多信息，参见[使用代理用户](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000751985)。
* SELECT ... FOR UPDATE 支持层次查询：支持在 select ... for update 语句中引用 start with ... connect by 语句。更多信息，参见[SELECT 语句](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000753403)。

## 多模支持

### Oracle XML

新版本扩展支持 XmlConcat、XmlForest 表达式，可以将多个 XMLType 数据合并为一个 XMLType 或根据 Key 和 Value 创建XML 片段并串联合并为一个 XML。支持 EXISTSNODE 及 PL 下 EXISTSNODE 表达式，用于判断 XML 数据中是否存在某个节点；支持 PL 下 EXTRACT 表达式，用于查询 XML 数据中指定 Xpath 的值。

更多信息，参见[XMLCONCAT](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000753984)。

### MySQL GIS

新版本 MySQL 模式下扩展支持 PostGis _ST_GeoHash 表达式，用于计算 geometry 的 geohash 编码；扩展 PostGis _ST_MAKEPOINT 表达式，用于根据坐标创建 2D 和 3D 的 geometry point；新增支持 MySQL ST_ASGEOJSON表达式，用于将 Geometry（WKB）按一定的格式转成 Json（Binary）。

### JSON/XML/GIS 内存优化

新版本优化了 JSON 表达式执行过程中内存占用，优化了插入更新 XML和输出 XML 的场景的内存占用，优化了GIS 类型数据输入、输出以及部分查询场景的内存占用。

### GIS 空间关系计算性能优化

新版本优化了 ST_INTERSECTS/ST_CONTAINS/_ST_COVERS/ST_WITHIN 等空间关系计算表达式的计算性能。

更多信息，参见[空间关系函数](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000753444)。

### OUTROW 存储的 LOB 读写性能优化

新版本对 OUTROW 存储的 LOB 进行了性能优化。

更多信息，参见[lob_enable_block_cache_threshold](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000751507)。

## OBKV 增强

### OBKV 全局索引

新版本增加支持 OBKV 的全局索引功能，insert、update、delete、insert_or_update、replace、increment/append 等 DML 操作均适用于全局索引表，并支持了 query 、异步 query 指定全局索引查询。

更多信息，参见[TableAPI 全局索引的使用范围与示例](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000749460)。

### OBKV 性能优化

新版本在多个场景，进行了性能优化：新增 Put 功能、支持组提交、优化 Batch 批处理、优化 Schema 获取逻辑、Batch 只返回一个结果。

## 性能提升

### DML 性能优化

OceanBase 已经支持通过 PDML 的并行执行机制来提高对大型表和索引执行插入、更新、删除等操作的性能。但是仍然存在部分场景是 PDML 暂未覆盖的，如 replace into ...、insert ... on duplicate key 、insert all ...、merge into ... 更新主键、insert 包含自增列、多表 update 等。以上场景在之前版本会使用单线程写入方式，在数据量较大时响应时间较长，影响客户体验。为了解决大数据量的这些场景的性能瓶颈，新版本新增支持 DAS 层并发写入能力，通过类似 PDML 的并发控制机制，显著提升 DML 执行性能。

更多信息，参见[与并行执行相关的 Hint](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000753969)。

### 备份性能优化

OceanBase 备份过程中通过连续性校验确保基线版本大于转储版本以保证数据完整，但连续性检查涉及读取备份介质上的数据并执行带锁操作，影响了备份性能。新版本优化了备份过程中连续性校验操作的性能开销，支持通过 ha_low_thread_score 控制备份使用的线程数，有效提高备份性能。

更多信息，参见[ha_low_thread_score](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000751477)。

### 网络备库性能优化

新版本优化了 RPC 及网络框架，降低了主备库之间的日志传输耗时；同时优化了备库受控拉日志流程，减少了备租户拉日志受控的频率，提高了主备之间的日志同步性能。

### 存储过程 DDL 执行编译结果缓存和落盘

新版本补充支持存储过程 DDL 执行成功后将编译结果缓存到 PL Cache 并落盘的行为，后续执行存储过程时，提升直接命中 PL Cache 缓存的概率，进一步提高存储过程执行性能。

### 并行 DDL 扩展

新版本扩展支持并行 CREATE VIEW，进一步提升 OMS 的结构迁移速度。

更多信息，参见[并行 DDL](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000749919)。

### 自增列 Order 模式性能优化

自增列 Order 模式下，需要保持数据插入的连续性。为了保证分布式架构下自增列的有序，在自增列 INSERT 时会将该值持久化到内部表，高并发情况下，响应时间会比较长。新版本对该场景做了优化，通过cache size 预取有效降低内部表访问次数，从而显著提升性能。

### Sequence Order 模式性能优化

OceanBase 已支持指定 order + cache 属性来创建全局连续生成的序列，但早期的实现中会忽略 cache 属性，等同于 order + nocache，在高并发场景会有明显性能问题。新版本对该场景进行了优化，通过选取中心节点来支持 order + cache 生成连续序列，真正意义上实现 cache 属性，显著提升高并发场景执行性能。

### Show Table Status 性能优化

老版本 show table status from ... like ... 场景性能较差，未利用 table_name 相关索引。新版本针对存在单表过滤条件的场景，显著提升查询性能。

更多信息，参见[SHOW](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000752528)。

## 资源优化

### CLOG 存储压缩

新版本新增 CLOG 日志存储压缩功能，通过将事务提交的日志进行压缩，间接提高日志盘吞吐能力，提升日志盘可容纳的事务日志总量。

### OBServer 到 ODP 的链路压缩功能

实际业务场景中，存在应用和数据库服务跨城部署的情况，距离较远、带宽有限，但仍然有大数据量读写的需求。为了降低大数据量传输带来的带宽消耗，新版本支持了 OBServer 到 ODP 的链路压缩功能，需配合 ODP 4.2.3 或以上版本开启使用。

### DDL 临时结果空间优化

现有的 DDL 过程存在临时文件使用磁盘空间放大的问题，新版本针对性地梳理和去除了数据流中的冗余结构，并支持了临时结果落盘的编码压缩，有效降低 DDL 临时结果占用的磁盘空间。

### 全局 CPU 前后台任务隔离

新版本支持了全局 CPU 前后台任务隔离能力，可以在整体层面上限制后台任务的可用资源，相对租户内使用 DBMS_RESOURCE_MANAGER 单独配置更加方便易用。

更多信息，参见[使用全局 CPU 资源的前后台隔离](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000752035)。

### 分区均衡策略优化

新版本优化了分区均衡策略，在建分区表时支持了连续分区打散；当用户表存在 longtext/lob 列、局部索引时，分区磁盘均衡时也会计算关联表，使得磁盘使用更加均衡。

更多信息，参见[租户内均衡](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000752113)。

### 系统日志压缩

新版本增加系统日志压缩功能，支持对 observer.log、rootservice.log、election.log、trace.log 等日志文件，每类超过 syslog_file_uncompressed_count 个数时，采用 syslog_compress_func 设置的压缩方法，对最早日志进行压缩。当日志使用总空间接近 syslog_disk_size 设置的磁盘空间上限时，开始删除最早生成的日志文件，回收空间。磁盘空间不变的情况下，开启 zstd 压缩后，预计可以存储不开启压缩时 20 倍的日志量。

更多信息，参见[日志压缩与解压](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000749035)。

## 更高的可靠性

### 迁移复制源端选择优化

新版本将各 server 按照地域信息划分为同 idc、同 region 不同 idc、跨 region 三种区域关系，提供枚举配置项 choose_migration_source_policy，支持用户配置指定迁移复制选择源端的优先模式，以便优先考虑地理位置就近因素以及 Follower 副本来提升迁移效率、降低 Leader 压力。

更多信息，参见[choose_migration_source_policy](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000751432)。

### 数据盘满停写

新版本在内核层面增加数据盘满停写功能，当用户数据盘水位线达到 data_disk_write_limit_percentage 配置后，用户写入请求会报错。通过删表、 transfer 或者扩磁盘方式降低数据盘使用比列后，用户写入操作可以自动恢复。

更多信息，参见[data_disk_write_limit_percentage](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000751595)。

## 更强的高可用

### 备份恢复支持 S3/OBS/GCS

OceanBase 的备份恢复功能已经支持两类存储介质：文件存储（NFS）和对象存储（OSS/COS）。新版本备份恢复增加支持 AWS S3、华为云 OBS、GCP GCS 存储服务，可以将 S3/OBS/GCS 作为日志归档和数据备份的目的端，也可以使用 S3/OBS/GCS 上的备份数据执行物理恢复。

更多信息，参见[物理备份与恢复概述](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000749085)。

### SET/PIECE 级物理恢复

新版本增加了 SET/PIECE 级物理恢复功能，提供 add restore source 命令来加载新路径的数据备份集 SET 或日志归档 PIECE，允许按需恢复到指定时间。

更多信息，参见[执行指定路径的恢复](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000749345)。

## 更高的易用性

### OceanBase LogMiner

新版本新增 OceanBase LogMiner（简称 ObLogMiner）工具支持。ObLogMiner 是一款用来对 OceanBase 数据库进行日志分析的命令行工具，支持在线及离线的日志分析。ObLogMiner 通过 OBCDC 来拉取并解析 CLOG 日志，并将 OBCDC 输出的逻辑日志转化成易读的格式存储到指定位置。适用于数据误操作和数据分析场景。

更多信息，参见[OBLogMiner 概述](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000749609)。

### Buffer 表自适应合并优化

新版本优化了 Buffer 表自适应合并特性，提供了 5 种档位的合并策略，允许用户根据业务场景为每张表设置不同的 table_mode，来应对 Buffer 表引起的读放大现象，从而提高系统长期运行下的 QPS 等性能指标。

更多信息，参见[自适应合并](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000749866)。

### Format Outline

新版本新增 Format Outline 特性，提供了一种更为宽松的匹配规则。当用户创建 Format Outline 时，在 Outline 原有流程之前，系统会先做一次忽略大小写、空格等非语法定义符号的操作，归一化为标准格式，这使得归一化后得到同样 Format SQL Text 或 Format SQL ID 的用户请求都可以命中同一个 Format Outline。另外针对 INLIST 个数不固定的场景，如业务不固定下发 in (1,2) 、 in (4,5,6) 、in (7,8,9,10)时 ，Normal Outline 精准匹配功能需要绑定 in (?,?)、in (?,?,?)、in (?,?,?,?) 三个 Outline 来控制执行计划；新版本的 Format Outline 功能只需绑定一次，系统会归一化为 in (?)，使得 INLIST 个数不同的多个 SQL 可以共享一个 Outline。当 Normal Outline 与 Format Outline 同时存在时，优先匹配 Normal Outline。

更多信息，参见[CREATE FORMAT OUTLINE](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000752565)。

### 索引使用监控

新版本新增索引使用监控功能，用户可选择打开该功能并设置采样方式，在普通租户下会将符合规则的索引使用信息记录到内存，并以 15 分钟为周期刷新到内部表中，可通过 DBA_INDEX_USAGE 视图访问，以此来感知表上的索引是否有被引用，进而选择删除无用的索引表来释放空间。

更多信息，参见[监控索引](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000751249)。

### 系统日志优化

新版本系统日志目录下，新增 ./alert/alert.log 日志文件，用于记录 DBA 关注的日志信息，初步解决 observer.log 日志量大、可读性差的问题。

更多信息，参见[日志概述](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000749042)。

### 日志流副本管理

新版本重新设计实现了日志流副本级别任务的运维方式，提供了一系列语法，用于支持日志流副本的添加、删除、副本类型转换、迁移、修改日志流 paxos 成员数量和取消容灾任务等能力，满足客户手动运维日志流副本的需求。

更多信息，参见[增加副本](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000749739)。

### 物理恢复进度统计

新版本增加物理恢复进度统计功能，可通过 CDB/DBA_OB_RESTORE_PROGRESS 视图随时查看恢复的实时进度。

更多信息，参见[查看物理恢复结果](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000749348)。

### PX 诊断能力增强

新版本在 SQL Plan Monitor 中增加记录了算子运行时的内存使用量、磁盘使用量，整个执行过程的最大内存使用量、最大磁盘使用量等信息。并在 SQL Audit 中增加记录 QC 对应 trace_id 下的 memtable、sstable 行数信息，并支持汇总各 PX Worker 对应 trace_id 下的相关信息。同时也支持了 OBDiag 工具依据 trace_id 拉取最初报错机器日志的功能。

更多信息，参见[V$SQL_PLAN_MONITOR](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000750106)。

### PS 诊断能力增强

新版本新增 [g]v$ob_session_ps_info 系统视图，用于展示各个 session 的 PS 引用信息，以便准确定位 PS 句柄泄漏等问题。

更多信息，参见[V$OB_SESSION_PS_INFO](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000750043)。

### ASH Report 节点级分析

新版本增加 ASH Report 节点级分析能力，可通过 DBMS_WORKLOAD_REPOSITORY.ASH_REPORT 包函数中新增的两个参数(节点 IP 和 Port)，指定单节点的 ASH Report 分析。

更多信息，参见[生成 ASH 报告](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000749940)。

### 自增列 Cache Size 表级设定

新版本新增自增列 cache size 表级设定功能，用户可以根据列类型/业务模型/业务流量等自定义配置不同表的缓存大小，从而做到跳变和性能的均衡。

更多信息，参见[定义自增列](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000751258)。

### NETWORK_WAIT_TIME 统计项

新版本 SQL AUDIT 中新增 NETWORK_WAIT_TIME 统计项，用于展示 NETWORK 类别的等待事件耗时，如同步 RPC、DAS 异步 RPC 锁等。在排查远程执行的慢 SQL 问题时，可以使用该统计项确认网络开销，辅助诊断。

更多信息，参见[V$OB_SQL_AUDIT](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000750094)。

### XA 事务监控统计项

新版本在 sysstat 中新增 XA_TRANS_START_COUNT、XA_READ_ONLY_TRANS_TOTAL_COUNT、XA_ONE_PHASE_COMMIT_TOTAL_COUNT 等 30 余项统计项，便于在 XA 事务流量发生变化时，用户可以及时感知。

### OBServer 支持 IPV6

新版本支持 IPV6 格式的 server ip，支持 sql 客户端、rpc 客户端以 IPV6 地址连接，同时也支持了 IPV4 和 IPV6 节点的混合部署。支持 IPV4 集群升级，但不支持旧的 IPV4 类型的集群升级到 IPV6 类型。

更多信息，参见[使用命令行部署三副本 OceanBase 集群](https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000751959)。
